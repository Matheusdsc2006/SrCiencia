{% load static %}   
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR. Ciência - Professor</title>
    <link rel="stylesheet" href="{% static 'css/professor_turmas.css' %}">
</head>
<body>
    <div class="container">
        <!-- Menu Lateral -->
        <aside class="sidebar">
            <div class="logo">
                <img src="{% static 'assets/sr_ciencia.svg' %}" alt="SR. Ciência">
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'pagina_inicial' %}"><img src="{% static 'assets/home.svg' %}" alt="">Página inicial</a></li>
                    <li><a href="#"><img src="{% static 'assets/profile.svg' %}" alt="">Meu perfil</a></li>
                    <li><a href="#"><img src="{% static 'assets/practice.svg' %}" alt="">Praticar</a></li>
                    <li><a href="{% if user.is_staff %}{% url 'professor_turmas' %}{% else %}{% url 'turmas' %}{% endif %}" class="active"><img src="{% static 'assets/classes.svg' %}" alt="">Turmas</a></li>
                    <li><a href="#"><img src="{% static 'assets/forum.svg' %}" alt="">Fórum</a></li>
                    <li><a href="#"><img src="{% static 'assets/help.svg' %}" alt="">Ajuda</a></li>
                    <li><a href="{% url 'login' %}" class="logout" style="color: #e72427;"><img src="{% static 'assets/logout.svg' %}" alt="">Sair</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-container">
            <div class="header">
                <div class="header-input">
                    <p class="cod">* Repasse o código aos alunos</p>
                    <button id="create-class-btn" class="btn-create">Criar turma</button>
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-avatar">
                            <figure>
                                <img src="{% static 'assets/user.avif' %}" alt="Usuário">
                            </figure>
                        </div>
                        <div>
                            <p class="user-name">{{ user.username }}</p>
                            <p class="user-email">{{ user.email }}</p>
                        </div>
                    </div>
                </div>
                <button id="change-account-btn" class="change-account">Mudar de conta</button>
            </div>
            <div class="cards">
                {% if turmas %}
                    {% for turma in turmas %}
                        <div class="card {{ turma.cor }}">
                            <div class="card-header">
                                <h3>{{ turma.nome }}</h3>
                                <p>{{ turma.descricao }}</p>
                            </div>
                            <p>{{ turma.codigo }}</p>
                            <div class="card-actions">
                                <button onclick="window.location.href='{% url 'alunos_turma' turma.id %}'">Ver alunos</button>
                                <button onclick="window.location.href='{{ turma.google_drive_url }}'">Abrir pasta no Google Drive</button>
                                <button class="cancel" data-turma-id="{{ turma.id }}" data-turma-name="{{ turma.nome }}">Excluir turma</button>

                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Você ainda não criou nenhuma turma.</p>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Modal de Criação de Turma -->
    <div id="create-class-modal" class="modal">
        <div class="modal-content">
            <span class="close-icon" id="close-create-modal">&times;</span>
            <h2>Criar nova turma</h2>
            <form id="create-class-form">
                <label for="class-name" class="disciplina">Disciplina:</label>
                <input type="text" id="class-name" name="class_name" placeholder="Digite a disciplina" required />

                <label for="class-description" class="turma">Turma/Turno:</label>
                <input id="class-description" name="class_description" placeholder="Ex. Eletrotécnica - 2V" required />

                <button type="submit" class="btn-confirm">Criar turma</button>
            </form>
        </div>
    </div>
    

<!-- Modal de Confirmação para Excluir Turma -->
<div id="delete-class-modal" class="modal">
    <div class="modal-content">
        <span class="close-icon" id="close-delete-modal">&times;</span>
        <h2>Como segurança, confirme sua senha</h2>
        <form id="delete-class-form">
            {% csrf_token %}
            <input type="password" id="delete-password-input" placeholder="Digite sua senha" class="senha" required>
            <button type="submit" class="btn-confirm">Confirmar</button>
        </form>
        
    </div>
</div>

<!-- Modal de Mudar conta -->
<div id="account-modal" class="modal">
    <div class="modal-content">
        <span id="close-modal" class="close-icon">&times;</span>
        <h2 class="selecione">Selecione ou remova uma conta</h2>
        <ul class="account-list">
        </ul>
        <form id="add-account-form">
            <label for="new-account" class="email">E-mail:</label>
            <input type="email" id="new-account" placeholder="Digite um e-mail" required />
            <button id="add-account-btn" class="btn-confirm">Adicionar Conta</button>
        </form>
    </div>
</div>




    <script>
        document.addEventListener("DOMContentLoaded", function () {
    const createClassModal = document.getElementById("create-class-modal");
    const deleteClassModal = document.getElementById("delete-class-modal");
    const closeCreateModal = document.getElementById("close-create-modal");
    const closeDeleteModal = document.getElementById("close-delete-modal");
    const createClassForm = document.getElementById("create-class-form");
    const deleteClassForm = document.getElementById("delete-class-form");
    const deletePasswordInput = document.getElementById("delete-password-input");
    const createClassBtn = document.getElementById("create-class-btn");
    const accountModal = document.getElementById("account-modal");
    const changeAccountButton = document.getElementById("change-account-btn");
    const closeModalButton = document.getElementById("close-modal");
    const accountList = document.querySelector(".account-list");
    const addAccountButton = document.getElementById("add-account-btn");
    const newAccountInput = document.getElementById("new-account");
    const confirmationModal = document.createElement("div");
    const logoutConfirmationModal = document.createElement("div");

    let turmaIdToDelete = null;
    let selectedEmail = null;

    // Modal de confirmação para mudança de conta
    confirmationModal.id = "confirmation-modal";
    confirmationModal.className = "modal";
    confirmationModal.innerHTML = `
        <div class="modal-content">
            <h2>Deseja realmente mudar para esta conta?</h2>
            <div class="modal-actions">
                <button id="confirm-change-btn" class="btn-confirm">Sim</button>
                <button id="cancel-change-btn" class="btn-cancel">Não</button>
            </div>
        </div>`;
    document.body.appendChild(confirmationModal);

    window.addEventListener("click", (event) => {
        if (event.target === confirmationModal) {
            confirmationModal.style.display = "none";
        }
    });

    const confirmChangeButton = document.getElementById("confirm-change-btn");
    const cancelChangeButton = document.getElementById("cancel-change-btn");

    // Modal de confirmação para remoção da conta atual
    logoutConfirmationModal.id = "logout-confirmation-modal";
    logoutConfirmationModal.className = "modal";
    logoutConfirmationModal.innerHTML = `
        <div class="modal-content">
            <h2>Deseja realmente remover a conta atual?</h2>
            <p class="deslogado">Você será deslogado.</p>
            <div class="modal-actions">
                <button id="confirm-logout-btn" class="btn-confirm">Sim</button>
                <button id="cancel-logout-btn" class="btn-cancel">Não</button>
            </div>
        </div>`;
    document.body.appendChild(logoutConfirmationModal);

    const confirmLogoutButton = document.getElementById("confirm-logout-btn");
    const cancelLogoutButton = document.getElementById("cancel-logout-btn");

    window.addEventListener("click", (event) => {
        if (event.target === logoutConfirmationModal) {
            logoutConfirmationModal.style.display = "none";
        }
    });

    // Função para fechar todos os modais
    function closeAllModals() {
        accountModal.style.display = "none";
        confirmationModal.style.display = "none";
        logoutConfirmationModal.style.display = "none";
        deleteClassModal.style.display = "none";
    }

    // Abrir modal de criação de turma
    createClassBtn.addEventListener("click", () => {
        closeAllModals();
        createClassModal.style.display = "block";
    });

    // Fechar modal de criação
    closeCreateModal.addEventListener("click", () => {
        createClassModal.style.display = "none";
    });

    // Fechar modal de criação ao clicar fora
    window.addEventListener("click", (event) => {
        if (event.target === createClassModal) {
            createClassModal.style.display = "none";
        }
    });

    // Abrir modal de exclusão
    function openDeleteModal(turmaId) {
        closeAllModals();
        turmaIdToDelete = turmaId;
        deleteClassModal.style.display = "block";
    }

    // Fechar modal de exclusão
    closeDeleteModal.addEventListener("click", () => {
        deleteClassModal.style.display = "none";
        turmaIdToDelete = null;
    });

    // Fechar modal de exclusão ao clicar fora
    window.addEventListener("click", (event) => {
        if (event.target === deleteClassModal) {
            deleteClassModal.style.display = "none";
            turmaIdToDelete = null;
        }
    });

    // Submeter formulário de criação de turma
    createClassForm.addEventListener("submit", (event) => {
        event.preventDefault();

        const formData = new FormData(createClassForm);

        fetch("/professor_turmas/criar/", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value,
            },
            body: formData,
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    alert("Turma criada com sucesso.");
                    createClassModal.style.display = "none";
                    window.location.reload(); // Atualiza a página
                } else {
                    alert("Erro ao criar turma: " + data.message);
                }
            })
            .catch((error) => {
                console.error("Erro ao criar turma:", error);
                alert("Erro ao criar turma. Reinicie a página e tente novamente.");
            });
    });

    deleteClassForm.addEventListener("submit", (event) => {
        event.preventDefault();

        const password = deletePasswordInput.value.trim();
        if (!password) {
            alert("Por favor, insira sua senha.");
            return;
        }

        fetch(`/professor_turmas/excluir_turma/${turmaIdToDelete}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ senha: password }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    alert("Turma excluída com sucesso.");
                    deleteClassModal.style.display = "none";
                    window.location.reload(); // Atualiza a página
                } else {
                    alert("Erro ao excluir turma: " + data.message);
                }
            })
            .catch((error) => {
                console.error("Erro ao excluir turma:", error);
                alert("Erro ao excluir turma. Reinicie a página e tente novamente.");
            })
            .finally(() => {
                deletePasswordInput.value = ""; // Limpa o campo de senha
                turmaIdToDelete = null; // Limpa o ID da turma
            });
    });

    // Capturar o evento de clique nos botões de exclusão
    document.querySelectorAll(".cancel").forEach((button) => {
        button.addEventListener("click", (event) => {
            event.preventDefault(); // Impede o comportamento padrão de redirecionamento

            const turmaId = button.getAttribute("data-turma-id");
            const turmaName = button.getAttribute("data-turma-name");

            // Abre o modal de exclusão
            openDeleteModal(turmaId, turmaName);
        });
    });

    // Abrir modal ao clicar no botão "Mudar conta"
    changeAccountButton.addEventListener("click", () => {
        fetch("{% url 'listar_contas' %}")
            .then((response) => response.json())
            .then((data) => {
                const { contas, conta_atual } = data;
                renderAccounts(contas, conta_atual);
                closeAllModals();
                accountModal.style.display = "block";
            })
            .catch((error) => {
                console.error("Erro ao carregar contas:", error);
            });
    });

    // Fechar modal ao clicar no botão de fechar
    closeModalButton.addEventListener("click", () => {
        accountModal.style.display = "none";
    });

    // Fechar modal ao clicar fora dele
    window.addEventListener("click", (event) => {
        if (event.target === accountModal) {
            accountModal.style.display = "none";
        }
    });

    // Adicionar uma nova conta ao clicar no botão "Adicionar conta"
    addAccountButton.addEventListener("click", () => {
        const newAccount = newAccountInput.value.trim();
        if (!newAccount) {
            alert("Por favor, insira um e-mail válido.");
            return;
        }

        fetch("{% url 'mudar_conta' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ nova_conta: newAccount }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    alert("Conta adicionada com sucesso.");
                    newAccountInput.value = ""; // Limpar o campo de entrada
                    fetch("{% url 'listar_contas' %}")
                        .then((response) => response.json())
                        .then((updatedData) => {
                            renderAccounts(updatedData.contas, updatedData.conta_atual);
                        });
                } else {
                    alert(data.message);
                }
            })
            .catch((error) => {
                console.error("Erro ao adicionar conta:", error);
            });
    });

    // Função para renderizar a lista de contas no modal
    function renderAccounts(accounts, currentEmail) {
        accountList.innerHTML = ""; // Limpa a lista atual
        if (accounts.length === 0) {
            accountList.innerHTML = "<li class='empty'>Nenhuma conta adicionada.</li>";
        } else {
            accounts.forEach((account) => {
                const listItem = document.createElement("li");
                listItem.textContent = account;

                // Indicar qual é a conta atual
                if (account === currentEmail) {
                    listItem.textContent += " (atual)";
                    listItem.classList.add("current-account");
                }

                // Botão "Remover"
                const removeButton = document.createElement("button");
                removeButton.textContent = "Remover";
                removeButton.style.marginLeft = "10px";
                removeButton.style.color = "#e72427";
                removeButton.style.cursor = "pointer";

                removeButton.addEventListener("click", (event) => {
                    event.stopPropagation(); // Impedir seleção acidental de conta
                    if (account === currentEmail) {
                        selectedEmail = account;
                        closeAllModals();
                        logoutConfirmationModal.style.display = "block";
                    } else {
                        removeAccount(account, currentEmail);
                    }
                });

                listItem.appendChild(removeButton);
                listItem.addEventListener("click", () => {
                    if (account === currentEmail) {
                        alert("Você já está logado com essa conta.");
                    } else {
                        selectedEmail = account;
                        closeAllModals();
                        confirmationModal.style.display = "block";
                    }
                });

                accountList.appendChild(listItem);
            });
        }
    }

    // Confirmar mudança de conta
    confirmChangeButton.addEventListener("click", () => {
        confirmationModal.style.display = "none";
        if (selectedEmail) {
            window.location.href = `{% url 'login' %}?email=${encodeURIComponent(selectedEmail)}`;
        }
    });

    // Cancelar mudança de conta
    cancelChangeButton.addEventListener("click", () => {
        confirmationModal.style.display = "none";
        selectedEmail = null;
    });

    // Confirmar remoção da conta atual
    confirmLogoutButton.addEventListener("click", () => {
        logoutConfirmationModal.style.display = "none";
        window.location.href = "{% url 'login' %}"; // Redirecionar para login ao remover conta atual
    });

    // Cancelar remoção da conta atual
    cancelLogoutButton.addEventListener("click", () => {
        logoutConfirmationModal.style.display = "none";
        selectedEmail = null;
    });

    // Remover conta
    function removeAccount(email, currentEmail) {
        fetch("{% url 'remover_conta' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ conta: email }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    alert("Conta removida com sucesso.");
                    // Atualizar a lista de contas
                    fetch("{% url 'listar_contas' %}")
                        .then((response) => response.json())
                        .then((updatedData) => {
                            renderAccounts(updatedData.contas, updatedData.conta_atual);
                        });
                } else {
                    alert(data.message);
                }
            })
            .catch((error) => {
                console.error("Erro ao remover conta:", error);
            });
    }
});


</script>
</body>
</html>