{% extends "base-core.html" %}
{% load static %}
{% block content %}
<main>
    <div class="header-container">
        <a href="{% url 'questao_list' %}" class="btn-back">Voltar</a>
        <h2 class="quest">Gerenciar Tópicos</h2>
    </div>
    <h3 class="list-title">Adicionar Tópico</h3>
    <form method="post" class="form-container">
        {% csrf_token %}
        {{ form.as_p }}
        <div class="btn-group">
            <button type="submit" name="add" class="btn btn-save">Salvar</button>
        </div>
    </form>
    <div class="search-container">
        <h3 class="list-title">Lista de Tópicos</h3>
        <input type="text" id="search-input" class="search-input" placeholder="Buscar tópicos...">
    </div>
    <div id="list-container" class="list-container">
        {% for topico in topicos|slice:":5" %}
        <div class="list-item">
            <span>
                {{ topico.nome }}
                <span style="font-weight: 400; color: var(--gray);">
                    ({{ topico.conteudo.nome }})
                </span>
            </span>
            <form method="post" class="delete-form">
                {% csrf_token %}
                <input type="hidden" name="topico_id" value="{{ topico.id }}">
                <button type="submit" name="delete" class="btn-delete">Remover</button>
            </form>
        </div>
        {% endfor %}
        {% if topicos|length > 5 %}
        <button id="view-more-btn" class="btn btn-back full-width">Ver mais</button>
        {% endif %}
    </div>
    <div id="all-topics-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close-icon">&times;</span>
            <h3 class="list-title">Todos os Tópicos</h3>
            <input type="text" id="modal-search-input" class="search-input" placeholder="Buscar tópicos no modal...">
            <div id="modal-list-container" class="modal-list-container">
                {% for topico in topicos %}
                <div class="list-item">
                    <span>
                        {{ topico.nome }}
                        <span style="font-weight: 400; color: var(--gray);">
                            ({{ topico.conteudo.nome }})
                        </span>
                    </span>
                    <form method="post" class="delete-form">
                        {% csrf_token %}
                        <input type="hidden" name="topico_id" value="{{ topico.id }}">
                        <button type="submit" name="delete" class="btn-delete">Remover</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</main>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    var searchInput = document.getElementById("search-input");
    var listContainer = document.getElementById("list-container");
    var viewMoreBtn = document.getElementById("view-more-btn");
    var modal = document.getElementById("all-topics-modal");
    var closeModal = document.getElementById("close-modal");

    if (viewMoreBtn) {
        viewMoreBtn.addEventListener("click", () => {
            modal.style.display = "block";
        });
    }

    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });
});

    searchInput.addEventListener("input", () => {
        var query = searchInput.value;
        fetch(`{% url 'buscar_topicos' %}?q=${query}`)
            .then(response => response.json())
            .then(data => {
                listContainer.innerHTML = "";
                if (data.length === 0) {
                    listContainer.innerHTML = "<p>Nenhum tópico encontrado.</p>";
                    return;
                }
                data.forEach(item => {
                    var div = document.createElement("div");
                    div.className = "list-item";
                    div.innerHTML = `
                        <span>${item.nome} 
                            <span style="font-weight: 400; color: gray;">
                                (${item.conteudo_nome})
                            </span>
                        </span>
                        <form method="post" class="delete-form">
                            {% csrf_token %}
                            <input type="hidden" name="topico_id" value="${item.id}">
                            <button type="submit" name="delete" class="btn-delete">Remover</button>
                        </form>`;
                    listContainer.appendChild(div);
                });
            });
    });
</script>
{% endblock %}
