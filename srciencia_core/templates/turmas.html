<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR. Ciência - Turmas</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/turmas.css' %}">
</head>
<body>
    <div class="container">
        <!-- Menu Lateral -->
        <aside class="sidebar">
            <div class="logo">
                <img src="{% static 'assets/sr_ciencia.svg' %}" alt="SR. Ciência">
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'pagina_inicial' %}"><img src="{% static 'assets/home.svg' %}" alt="">Página inicial</a></li>
                    <li><a href="#"><img src="{% static 'assets/profile.svg' %}" alt="">Meu perfil</a></li>
                    <li><a href="#"><img src="{% static 'assets/practice.svg' %}" alt="">Praticar</a></li>
                    <li><a href="#" class="active"><img src="{% static 'assets/classes.svg' %}" alt="">Turmas</a></li>
                    <li><a href="#"><img src="{% static 'assets/forum.svg' %}" alt="">Fórum</a></li>
                    <li><a href="#"><img src="{% static 'assets/help.svg' %}" alt="">Ajuda</a></li>
                    <li><a href="#" class="logout" style="color: #e72427;"><img src="{% static 'assets/logout.svg' %}" alt="">Sair</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-container">
            <div class="header">
                <div class="header-input">
                    <label for="codigo-turma">Código da turma:</label>
                    <input type="text" id="codigo-turma" placeholder="Peça ao seu professor o código da turma e digite aqui">
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-avatar">
                            <figure>
                                <img src="{% static 'assets/bugas.png' %}" alt="Lucas Albuquerque">
                            </figure>
                        </div>
                        <div>
                            <p class="user-name">Lucas Albuquerque</p>
                            <p class="user-email">{{ conta_atual }}</p>
                        </div>
                    </div>
                    <button class="change-account">Mudar de conta</button>
                </div>
            </div>
            <div class="cards">
                {% if turmas %}
                    {% for turma in turmas %}
                        <div class="card {{ turma.cor }}">
                            <div class="card-header">
                                <h3>{{ turma.nome }}</h3>
                                <p>{{ turma.descricao }}</p>
                            </div>
                            <p>{{ turma.professor }}</p>
                            <div class="card-actions">
                                <button onclick="window.location.href='{% url 'pendentes' turma.id %}'">Trabalhos pendentes</button>
                                <button onclick="window.location.href='{{ turma.google_drive_url }}'">Abrir pasta no Google Drive</button>
                                <button class="cancel" onclick="window.location.href='{% url 'cancelar_inscricao' turma.id %}'">Cancelar inscrição</button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Não há turmas cadastradas para esta conta.</p>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Modal para Gerenciar Contas -->
    <div id="account-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close-icon">&times;</span>
            <h2>Adicionar ou selecionar uma conta</h2>
            <ul class="account-list">
                {% for conta in contas %}
                    <li>
                        <span>{{ conta }}</span>
                        <button class="select-account" data-email="{{ conta }}">Selecionar</button>
                    </li>
                {% endfor %}
            </ul>
            <div class="add-account">
                <input type="email" id="new-account" placeholder="Digite um e-mail" />
                <button id="add-account-btn">Adicionar Conta</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("account-modal");
            const closeModal = document.getElementById("close-modal");
            const changeAccountButton = document.querySelector(".change-account");
            const accountList = document.querySelector(".account-list");
            const newAccountInput = document.getElementById("new-account");
            const addAccountButton = document.getElementById("add-account-btn");
            const userEmailElement = document.querySelector(".user-email");
    
            let accounts = []; // Lista de contas adicionadas
    
            // Mostrar o modal ao clicar no botão "Mudar de Conta"
            changeAccountButton.addEventListener("click", () => {
                modal.style.display = "block";
                renderAccounts(); // Atualiza a lista ao abrir o modal
            });
    
            // Fechar o modal ao clicar no "X"
            closeModal.addEventListener("click", () => {
                modal.style.display = "none";
            });
    
            // Fechar o modal ao clicar fora do conteúdo
            window.addEventListener("click", (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
    
            // Adicionar uma nova conta
            addAccountButton.addEventListener("click", () => {
                const newAccount = newAccountInput.value.trim();
    
                if (!newAccount || !validateEmail(newAccount)) {
                    alert("Por favor, insira um e-mail válido.");
                    return;
                }
    
                if (accounts.includes(newAccount)) {
                    alert("Esta conta já foi adicionada.");
                    return;
                }
    
                accounts.push(newAccount);
                renderAccounts(); // Atualiza a lista
                newAccountInput.value = ""; // Limpa o campo
                alert("Conta adicionada com sucesso.");
            });
    
            // Renderizar a lista de contas
            function renderAccounts() {
                accountList.innerHTML = ""; // Limpar a lista atual
    
                if (accounts.length === 0) {
                    const emptyMessage = document.createElement("li");
                    emptyMessage.classList.add("empty");
                    emptyMessage.textContent = "Nenhuma conta adicionada.";
                    accountList.appendChild(emptyMessage);
                } else {
                    accounts.forEach((account, index) => {
                        const listItem = document.createElement("li");
                        listItem.textContent = account;
    
                        // Evento de seleção de conta
                        listItem.addEventListener("click", () => {
                            switchAccount(account); // Trocar para a conta selecionada
                        });
    
                        // Botão "Remover"
                        const removeButton = document.createElement("button");
                        removeButton.textContent = "Remover";
                        removeButton.style.marginLeft = "10px";
                        removeButton.style.color = "#e72427";
                        removeButton.style.cursor = "pointer";
    
                        // Evento de remoção
                        removeButton.addEventListener("click", (event) => {
                            event.stopPropagation(); // Impede o evento do item da lista
                            accounts.splice(index, 1); // Remove a conta do array
                            alert("Conta removida com sucesso."); // Mensagem ao remover
                            renderAccounts(); // Atualiza a lista
                        });
    
                        listItem.appendChild(removeButton);
                        accountList.appendChild(listItem);
                    });
                }
            }
    
            // Trocar de conta no backend
            function switchAccount(email) {
                fetch("{% url 'mudar_conta' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ nova_conta: email }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            userEmailElement.textContent = email; // Atualiza apenas o email no frontend
                            alert(data.message); // Mensagem de sucesso
                            modal.style.display = "none"; // Fecha o modal
                            location.reload(); // Recarrega a página para refletir mudanças
                        } else {
                            alert(data.message); // Mensagem de erro
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao enviar requisição:", error);
                        alert("Erro ao mudar de conta. Tente novamente.");
                    });
            }
    
            // Função para validar e-mails
            function validateEmail(email) {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                return emailRegex.test(email);
            }
    
            // Atualizar a lista de contas ao carregar a página
            function initializeAccounts() {
                fetch("{% url 'listar_contas' %}")
                    .then((response) => response.json())
                    .then((data) => {
                        accounts = data.contas || [];
                        renderAccounts(); // Renderiza a lista inicial
                        userEmailElement.textContent = data.conta_atual || "Nenhuma conta selecionada"; // Atualiza o email no frontend
                    })
                    .catch((error) => {
                        console.error("Erro ao carregar contas:", error);
                    });
            }
    
            initializeAccounts(); // Chamada inicial para configurar a lista
        });
    </script>    
</body>
</html>