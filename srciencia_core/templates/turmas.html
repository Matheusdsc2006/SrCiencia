{% load static %}   
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>SR. Ciência - Turmas</title>
    <link rel="stylesheet" href="{% static 'css/turmas.css' %}">
</head>
<body>
    <div class="container">
        <!-- Menu Lateral -->
            <aside class="sidebar">
                <div class="logo">
                <img src="{% static 'assets/sr_ciencia.svg' %}" alt="SR. Ciência">
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'pagina_inicial' %}"><img src="{% static 'assets/home.svg' %}" alt="">Página inicial</a></li>
                    <li><a href="#"><img src="{% static 'assets/profile.svg' %}" alt="">Meu perfil</a></li>
                    <li><a href="#"><img src="{% static 'assets/practice.svg' %}" alt="">Praticar</a></li>
                    <li><a href="{% if user.is_staff %}{% url 'turmas' %}{% else %}{% url 'turmas' %}{% endif %}" class="{% if active_menu == 'turmas' %}active{% endif %}"><img src="{% static 'assets/classes.svg' %}" alt="">Turmas</a></li>
                    <li><a href="#"><img src="{% static 'assets/forum.svg' %}" alt="">Fórum</a></li>
                    <li><a href="#"><img src="{% static 'assets/help.svg' %}" alt="">Ajuda</a></li>
                    <li><a href="{% url 'login' %}" class="logout" style="color: #e72427;"><img src="{% static 'assets/logout.svg' %}" alt="">Sair</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="main-container">
            <div class="header">
                <div class="header-input">
                    <label for="codigo-turma">Código da turma:</label>
                    <div class="input-wrapper">
                        <input type="text" id="codigo-turma" placeholder="Peça ao seu professor o código da turma e digite aqui">
                        <button id="submit-codigo-turma" class="btn-submit">
                            <img src="{% static 'assets/arrow-right.svg' %}" alt="Enviar" class="submit-icon">
                        </button>                        
                    </div>
                </div>                
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-avatar">
                            <figure>
                                <img src="{% static 'assets/user.avif' %}" alt="Usuário">
                            </figure>
                        </div>
                        <div>
                            <p class="user-name">{{ user.username }}</p>
                            <p class="user-email">{{ conta_atual }}</p>
                        </div>
                    </div>
                    <button id="change-account-btn" class="change-account">Mudar de conta</button>
                </div>
            </div>
            <div class="cards">
                {% if turmas %}
                    {% for turma in turmas %}
                    <div class="card {{ turma.cor }}">
                        <div class="card-header">
                            <h3>{{ turma.nome }}</h3>
                            <p>{{ turma.descricao }}</p>
                        </div>
                        <p>Professor: {{ turma.professor__username }}</p>
                        <div class="card-actions">
                            <button onclick="window.location.href='/turmas/{{ turma.id }}/pendentes/'">Trabalhos pendentes</button>
                            <button onclick="window.location.href='{{ turma.google_drive_url }}'">Pasta no Google Drive</button>
                            <button class="cancel" onclick="window.location.href='/turmas/{{ turma.id }}/cancelar/'">Cancelar inscrição</button>
                        </div>
                    </div>
                {% endfor %}
                {% else %}
                    <p id="no-turmas-message">Não há turmas cadastradas para esta conta.</p>
                {% endif %}
            </div>            
        </main>
    </div>
<!-- Modal de Confirmação -->
<div id="confirmation-modal" class="modal">
    <div class="modal-content">
        <h2>Deseja realmente mudar de conta?</h2>
        <p>Você sairá da conta atual.</p>
        <div class="modal-actions">
            <button id="confirm-change-btn" class="btn-confirm">Sim</button>
            <button id="cancel-change-btn" class="btn-cancel">Não</button>
        </div>
    </div>
</div>


<div id="account-modal" class="modal">
    <div class="modal-content">
        <span id="close-modal" class="close-icon">&times;</span>
        <h2>Selecione ou remova uma conta</h2>
        <ul class="account-list">
            <!-- As contas serão renderizadas dinamicamente pelo JavaScript -->
        </ul>
        <div class="add-account">
            <input type="email" id="new-account" placeholder="Digite um e-mail" />
            <button id="add-account-btn">Adicionar Conta</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Remover Conta Atual -->
<div id="remove-confirmation-modal" class="modal">
    <div class="modal-content">
        <h2>Você sairá da conta atual</h2>
        <p style="font-size: smaller;">Deseja continuar?</p>
        <button id="confirm-remove-btn" class="confirm-btn">Sim</button>
        <button id="cancel-remove-btn" class="cancel-btn">Não</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const accountModal = document.getElementById("account-modal");
        const confirmationModal = document.getElementById("confirmation-modal");
        const removeConfirmationModal = document.getElementById("remove-confirmation-modal");
        const closeModal = document.getElementById("close-modal");
        const changeAccountButton = document.querySelector(".change-account");
        const accountList = document.querySelector(".account-list");
        const newAccountInput = document.getElementById("new-account");
        const addAccountButton = document.getElementById("add-account-btn");
        const userEmailElement = document.querySelector(".user-email");
        const confirmChangeButton = document.getElementById("confirm-change-btn");
        const cancelChangeButton = document.getElementById("cancel-change-btn");
        const confirmRemoveButton = document.getElementById("confirm-remove-btn");
        const cancelRemoveButton = document.getElementById("cancel-remove-btn");
        const submitButton = document.getElementById("submit-codigo-turma");
        const inputCodigoTurma = document.getElementById("codigo-turma");

        let accounts = [];
        const MAX_ACCOUNTS = 3;
        let selectedEmail = null;
        let currentEmail = null;

        function loadTurmasAluno() {
            fetch("/turmas/listar_turmas/")
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        renderTurmasAluno(data.turmas); // Renderizar turmas de alunos
                    } else {
                        console.error("Erro ao carregar turmas:", data.message);
                        document.querySelector(".cards").innerHTML =
                            "<p>Nenhuma turma encontrada para esta conta.</p>";
                    }
                })
                .catch((error) => {
                    console.error("Erro ao carregar turmas:", error);
                });
        }

        function renderTurmasAluno(turmas) {
            const cardsContainer = document.querySelector(".cards");
            cardsContainer.innerHTML = ""; // Limpar turmas existentes

            turmas.forEach((turma) => {
                const turmaCard = `
                    <div class="card">
                        <div class="card-header">
                            <h3>${turma.nome}</h3>
                            <p>${turma.descricao}</p>
                        </div>
                        <p>Professor: ${turma.professor__username || "Desconhecido"}</p>
                        <div class="card-actions">
                            <button onclick="window.location.href='/turmas/${turma.id}/pendentes/'">Trabalhos pendentes</button>
                            <button onclick="window.location.href='${turma.google_drive_url}'">Pasta no Google Drive</button>
                            <button class="cancel" onclick="window.location.href='/turmas/${turma.id}/cancelar/'">Cancelar inscrição</button>
                        </div>
                    </div>
                `;
                cardsContainer.innerHTML += turmaCard;
            });
        }

        // Chamar ao carregar a página
        document.addEventListener("DOMContentLoaded", loadTurmasAluno);


        // Função para renderizar turmas
        function renderTurma(turma) {
            const cardsContainer = document.querySelector(".cards");
            const noTurmasMessage = document.getElementById("no-turmas-message");

            // Remover a mensagem de "Nenhuma turma" se houver turmas
            if (noTurmasMessage) {
                noTurmasMessage.style.display = "none";
            }

            const turmaCard = `
                <div class="card">
                    <div class="card-header">
                        <h3>${turma.nome}</h3>
                        <p>${turma.descricao}</p>
                    </div>
                    <p>Professor: ${turma.professor__username}</p>
                    <div class="card-actions">
                        <button onclick="window.location.href='/turmas/${turma.id}/pendentes/'">Trabalhos pendentes</button>
                        <button onclick="window.location.href='/google-drive/${turma.id}/'">Abrir pasta no Google Drive</button>
                        <button class="cancel" onclick="window.location.href='/turmas/${turma.id}/cancelar/'">Cancelar inscrição</button>
                    </div>
                </div>
            `;
            cardsContainer.innerHTML += turmaCard; // Adicionar a nova turma
        }

        // Chamar a função ao carregar a página
        document.addEventListener("DOMContentLoaded", () => {
            const serverRenderedTurmas = JSON.parse('{{ turmas|safe }}'.replace(/&quot;/g, '"'));
            if (serverRenderedTurmas.length > 0) {
                renderTurmas(serverRenderedTurmas); // Renderizar turmas carregadas do backend
            } else {
                loadTurmas(); // Carregar turmas via API caso necessário
            }
        });



        // Abrir modal de gerenciamento de contas
        changeAccountButton.addEventListener("click", () => {
            closeAllModals();
            accountModal.style.display = "block";
            renderAccounts();
        });

        // Fechar modal de contas
        closeModal.addEventListener("click", () => {
            accountModal.style.display = "none";
        });

        // Fechar modal ao clicar fora
        window.addEventListener("click", (event) => {
            if (event.target === accountModal) {
                accountModal.style.display = "none";
            } else if (event.target === confirmationModal) {
                confirmationModal.style.display = "none";
            } else if (event.target === removeConfirmationModal) {
                removeConfirmationModal.style.display = "none";
            }
        });

        // Fechar todos os modais
        function closeAllModals() {
            accountModal.style.display = "none";
            confirmationModal.style.display = "none";
            removeConfirmationModal.style.display = "none";
        }

        // Adicionar nova conta
        addAccountButton.addEventListener("click", () => {
            const newAccount = newAccountInput.value.trim();

            if (accounts.length >= MAX_ACCOUNTS) {
                alert("Você atingiu o limite de 3 contas. Remova uma conta para adicionar outra.");
                return;
            }

            if (!newAccount || !validateEmail(newAccount)) {
                alert("Por favor, insira um e-mail válido.");
                return;
            }

            if (accounts.includes(newAccount)) {
                alert("Esta conta já foi adicionada.");
                return;
            }

            fetch("{% url 'mudar_conta' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ nova_conta: newAccount }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        accounts.push(newAccount);
                        renderAccounts();
                        newAccountInput.value = "";
                        alert("Conta adicionada com sucesso.");
                    } else {
                        alert(data.message);
                    }
                })
                .catch((error) => {
                    console.error("Erro ao adicionar conta:", error);
                    alert("Erro ao adicionar a conta. Tente novamente.");
                });
        });
        // Renderizar lista de contas
        
        function renderAccounts() {
            accountList.innerHTML = "";

            if (accounts.length === 0) {
                const emptyMessage = document.createElement("li");
                emptyMessage.classList.add("empty");
                emptyMessage.textContent = "Nenhuma conta adicionada.";
                accountList.appendChild(emptyMessage);
            } else {
                accounts.forEach((account) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = account;

                    // Se for a conta atual, desabilitar seleção
                    if (account === currentEmail) {
                        listItem.classList.add("current-account");
                        listItem.textContent += " (atual)";
                        listItem.addEventListener("click", () => {
                            alert("A conta selecionada deve ser diferente da atual!");
                        });
                    } else {
                        listItem.addEventListener("click", () => {
                            closeAllModals();
                            selectedEmail = account;
                            confirmationModal.style.display = "block";
                        });
                    }

                    // Botão "Remover"
                    const removeButton = document.createElement("button");
                    removeButton.textContent = "Remover";
                    removeButton.style.marginLeft = "10px";
                    removeButton.style.color = "#e72427";
                    removeButton.style.cursor = "pointer";

                    removeButton.addEventListener("click", (event) => {
                        event.stopPropagation();
                        if (account === currentEmail) {
                            // Modal de remoção da conta atual
                            closeAllModals();
                            selectedEmail = account;
                            removeConfirmationModal.style.display = "block";
                        } else {
                            // Remover conta diferente da atual
                            removeAccount(account);
                        }
                    });

                    listItem.appendChild(removeButton);
                    accountList.appendChild(listItem);
                });
            }
        }

        confirmChangeButton.addEventListener("click", () => { 
            closeAllModals(); // Fechar todos os modais
            if (selectedEmail) { // Verificar se há uma conta selecionada
                fetch("{% url 'mudar_conta' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ nova_conta: selectedEmail }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            redirectToLogin(selectedEmail); // Redirecionar para a tela de login com o e-mail
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao mudar conta:", error);
                        alert("Ocorreu um erro ao tentar alterar a conta. Tente novamente.");
                    });
            } else {
                alert("Nenhuma conta foi selecionada."); // Garantia de controle caso algo falhe
            }
        });

       // Cancelar troca de conta
        cancelChangeButton.addEventListener("click", () => {
            closeAllModals(); // Fechar todos os modais
            selectedEmail = null; // Limpar o e-mail selecionado para evitar erros
        });

        // Confirmar remoção da conta atual
        confirmRemoveButton.addEventListener("click", () => {
            closeAllModals();
            alert("Você foi deslogado.");
            redirectToLogin(null);
        });

        // Cancelar remoção de conta atual
        cancelRemoveButton.addEventListener("click", () => {
            closeAllModals();
        });

        // Remover conta
        function removeAccount(email) {
            fetch("{% url 'remover_conta' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ conta: email }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Remover a conta do frontend
                        accounts = accounts.filter((account) => account !== email);
                        renderAccounts();
                        alert("Conta removida com sucesso.");
                    } else {
                        if (data.message === "Confirme a remoção da conta atual.") {
                            closeAllModals();
                            removeConfirmationModal.style.display = "block";
                        } else if (
                            data.message ===
                            "Você não pode remover uma conta que acabou de adicionar. Para isso, adicione outra conta."
                        ) {
                            alert(data.message);
                        } else {
                            alert(data.message);
                        }
                    }
                })
                .catch((error) => {
                    console.error("Erro ao remover conta:", error);
                    alert("Erro ao remover a conta. Tente novamente.");
                });
        }

        // Redirecionar para a tela de login
        function redirectToLogin(email) {
            const loginUrl = email 
                ? `{% url 'login' %}?email=${encodeURIComponent(email)}`
                : `{% url 'login' %}`;
            window.location.href = loginUrl;
        }


        // Validar e-mail
        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }

        // Inicializar contas a partir do backend
        function initializeAccounts() {
            fetch("{% url 'listar_contas' %}")
                .then((response) => response.json())
                .then((data) => {
                    accounts = data.contas || [];
                    currentEmail = data.conta_atual;
                    userEmailElement.textContent = currentEmail;
                    renderAccounts();
                })
                .catch((error) => {
                    console.error("Erro ao carregar contas:", error);
                });
        }

        initializeAccounts();

        submitButton.addEventListener("click", () => {
            const codigoTurma = inputCodigoTurma.value.trim();

            if (!codigoTurma) {
                alert("Por favor, insira um código de turma.");
                return;
            }

            fetch("{% url 'verificar_codigo_turma' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ codigo_turma: codigoTurma }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Atualizar a lista de turmas na interface
                        renderTurma(data.turma); // Renderizar apenas a nova turma
                        alert(`Você foi adicionado à turma: ${data.turma.nome}`);
                    } else {
                        alert(data.message);
                    }
                })
                .catch((error) => {
                    console.error("Erro ao verificar o código da turma:", error);
                    alert("Erro ao verificar o código da turma. Tente novamente.");
                });
        });
});
</script>

</body>
</html>