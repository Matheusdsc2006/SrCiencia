{% load static %}    
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <input type="hidden" id="csrf_token" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <title>SR. Ciência - Praticar</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
            },
            svg: {
                fontCache: 'global',
            },
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>     
    <link rel="stylesheet" href="{% static 'css/praticar.css' %}">
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
</head>
<body>
    <main>
        <div class="container">
            <!-- Menu Lateral -->
            <aside class="sidebar">
                <div class="logo">
                    <img src="{% static 'assets/sr_ciencia.svg' %}" alt="SR. Ciência">
                </div>
                <nav>
                    <ul>
                        <li><a href="{% url 'pagina_inicial' %}"><img src="{% static 'assets/home.svg' %}" alt="">Página inicial</a></li>
                        <li>
                            <a href="{% if user.perfil == 3 %}{% url 'professor_perfil' %}{% elif user.perfil == 2 %}{% url 'aluno_perfil' %}{% endif %}">
                                <img src="{% static 'assets/profile.svg' %}" alt="">Meu Perfil
                            </a>
                        </li>
                        <li><a href="{% url 'aluno_praticar' %}" class="active"><img src="{% static 'assets/practice.svg' %}" alt="">Praticar</a></li>
                        <li>
                            <a href="{% if user.perfil == 3 %}{% url 'professor_turmas' %}{% else %}{% url 'turmas' %}{% endif %}">
                                <img src="{% static 'assets/classes.svg' %}" alt="">Turmas
                            </a>
                        </li>
                        <li><a href="#"><img src="{% static 'assets/forum.svg' %}" alt="">Fórum</a></li>
                        <li><a href="#"><img src="{% static 'assets/help.svg' %}" alt="">Ajuda</a></li>
                        <li><a href="{% url 'login' %}" class="logout"><img src="{% static 'assets/logout.svg' %}" alt="">Sair</a></li>
                    </ul>
                </nav>
            </aside>
    
            <!-- Cabeçalho -->
            <main class="main-container">
                <div class="header-container-inicio">
                    <div class="header-card">
                        <div class="user-info">
                            <div class="user-avatar">
                                <figure>
                                    <img src="{% static 'assets/user.avif' %}" alt="Usuário">
                                </figure>
                            </div>
                            <div>
                                <p class="user-name">{{ user.username }}</p>
                                <p class="user-email">{{ user.email }}</p>
                            </div>
                        </div>
                        <button id="change-account-btn" class="change-account">Mudar de conta</button>
                    </div>
                </div>
    
                <!-- Conteúdo da Página de Praticar -->
                <div class="header-container">
                    <h2 class="quest">Praticar</h2>
                </div>
    
                <!-- Filtros de Busca -->
                <form id="filtro-questoes-form" class="form-container">
                    <div class="form-group">
                        <label for="quantidade">
                            Quantidade de questões: <span style="color: red;">*</span>
                        </label>
                        <input type="number" id="quantidade" name="quantidade" placeholder="Máx. 50" min="1" max="50" required>
                    </div>
    
                    <div class="form-group">
                        <label for="disciplina">Disciplina:</label>
                        <select id="disciplina" name="disciplina">
                            <option value="">Todas</option>
                            {% for disciplina in disciplinas %}
                            <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
    
                    <div class="form-group">
                        <label for="conteudo">Conteúdo:</label>
                        <select id="conteudo" name="conteudo" disabled>
                            <option value="">Todos</option>
                        </select>
                    </div>
    
                    <div class="form-group">
                        <label for="dificuldade">Dificuldade:</label>
                        <select id="dificuldade" name="dificuldade">
                            <option value="">Todas</option>
                            <option value="1">Fácil</option>
                            <option value="2">Médio</option>
                            <option value="3">Difícil</option>
                        </select>
                    </div>
    
                    <div class="form-group">
                        <label style="margin-bottom: 10px;">Status:</label>
                        <div class="status-options" style="margin-bottom: 10px;">
                            <label>
                                <input type="checkbox" name="status" value="nao_resolvidas"> Não resolvidas
                            </label>
                            <label>
                                <input type="checkbox" name="status" value="que_errei"> Que errei
                            </label>
                            <label>
                                <input type="checkbox" name="status" value="favoritadas"> Favoritadas
                            </label>
                        </div>
                    </div>                    
                    <div class="form-group">
                        <label for="busca-questoes">Busca:</label>
                        <input
                            type="text"
                            id="busca-questoes"
                            name="busca_questoes"
                            placeholder="Digite o termo para buscar"
                            class="search-input"
                        >
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-save" id="gerar-atividade">Gerar atividade</button>
                        <button type="reset" class="btn btn-cancel">Limpar</button>
                        {% if user.perfil == 3 %}
                        <button type="button" class="btn btn-exportar" id="exportar-atividade">Exportar atividade</button>
                        {% endif %}
                    </div>
                </form>
    
                <!-- Área de feedback inicial -->
                <div id="white-space" class="hidden">
                    <h2 class="gerar">Aguardando filtro...</h2>
                </div>
                <div id="acertos-container" class="hidden">
                    <h3 class="acertos-text">Número de acertos: <span id="numero-acertos" style="margin-left: 10px;">0</span>/<span id="total-questoes">0</span></h3>
                </div>                                                         
                <!-- Conteúdo dinâmico das questões -->
                <section id="questoes-container">
                    <!-- Questões serão geradas aqui -->
                </section>
            </main>
        </div>
    </main>    

    <!-- Modal de Gerenciamento de Contas -->
    <div id="account-modal" class="modal">
        <div class="modal-content">
            <span id="close-account-modal" class="close-icon">&times;</span>
            <h2>Selecione ou remova uma conta</h2>
            <ul class="account-list"></ul>
            <form id="add-account-form">
                {% csrf_token %}
                <label for="new-account">E-mail:</label>
                <input type="email" id="new-account" placeholder="Digite um e-mail" required />
                <button id="add-account-btn" class="btn-confirm-sim" type="button">Adicionar Conta</button>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação para Mudar de Conta -->
    <div id="account-confirmation-modal" class="modal">
        <div class="modal-content">
            <span id="close-account-confirmation-modal" class="close-icon">&times;</span>
            <h2>Deseja realmente mudar de conta?</h2>
            <p style="font-size: 20px;">Você será redirecionado para a tela de login.</p>
            <div class="modal-actions">
                <button id="confirm-change-btn" class="btn-confirm-sim" style="font-weight: 400;">Sim</button>
            </div>
        </div>
    </div>

    <div id="confirm-finalize-modal" class="modal">
        <div class="modal-content">
            <span id="close-finalize-modal" class="close-icon">&times;</span>
            <h2>Confirmar Finalização</h2>
            <p>Tem certeza de que deseja finalizar a atividade? Suas respostas não poderão ser alteradas.</p>
            <button id="confirm-finalize-btn" class="btn-confirm-sim">Sim</button>
        </div>
    </div>    
     
    <div id="confirm-clear-modal" class="modal">
        <div class="modal-content">
            <span id="close-clear-modal" class="close-icon">&times;</span>
            <h2>Confirmar Limpeza</h2>
            <p>Tem certeza de que deseja limpar?</p>
            <button id="confirm-clear-btn" class="btn-confirm-sim">Sim</button>
        </div>
    </div>
    
    
<script>
    document.addEventListener("DOMContentLoaded", function () {
    configurarModalFinalizarAtividade();
    exibirResumo();
    carregarResumo();
    inicializarPagina();
    carregarFavoritosLocalStorage();
    // Referências dos elementos
    var disciplinaSelect = document.getElementById("disciplina");
    var conteudoSelect = document.getElementById("conteudo");
    var gerarAtividadeBtn = document.getElementById("gerar-atividade");
    var questoesContainer = document.getElementById("questoes-container");
    var quantidadeInput = document.getElementById("quantidade");
    var whiteSpace = document.getElementById("white-space");
    var toggleButtons = document.querySelectorAll(".toggle-visibility");
    var formData = new FormData(document.querySelector("#filtro-questoes-form"));
    var finalizarAtividadeBtn = document.getElementById("finalizar-atividade");
    var finalizarModal = document.getElementById("finalizar-atividade-modal");
    var closeFinalizarModal = document.getElementById("close-finalizar-modal");
    var confirmFinalizarBtn = document.getElementById("confirm-finalizar-btn");
    var clearButton = document.querySelector(".btn-cancel");
    var clearModal = document.getElementById("confirm-clear-modal"); 
    var closeClearModal = document.getElementById("close-clear-modal"); 
    var confirmClearButton = document.getElementById("confirm-clear-btn");
    var exportarAtividadeBtn = document.getElementById("exportar-atividade");
    var userEmail = "{{ user.email }}"; 
    var localStorageKey = `progressoAtividade_${userEmail}`;
    var questoesData = null;
    var accountModal = document.getElementById("account-modal");
    var accountConfirmationModal = document.getElementById("account-confirmation-modal");
    var changeAccountButton = document.getElementById("change-account-btn");
    var closeAccountModal = document.getElementById("close-account-modal");
    var closeAccountConfirmationModal = document.getElementById("close-account-confirmation-modal");
    var confirmChangeButton = document.getElementById("confirm-change-btn");
    var addAccountButton = document.getElementById("add-account-btn");
    var accountList = document.querySelector(".account-list");
    var newAccountInput = document.getElementById("new-account");
    let selectedEmail = null;


    // Função para salvar progresso no localStorage
    function salvarProgresso(questoes) {
    var progresso = {
        questoes: questoes, // Salva as questões renderizadas
        respostasSelecionadas: {} // Salva as alternativas selecionadas
    };

    // Salvar alternativas selecionadas
    document.querySelectorAll("input[type='radio']:checked").forEach((input) => {
        var questaoId = input.name.split("-")[1];
        progresso.respostasSelecionadas[questaoId] = input.value;
    });

    localStorage.setItem(localStorageKey, JSON.stringify(progresso));
}

    // Função para carregar progresso do localStorage
function carregarProgresso() {
    var progresso = JSON.parse(localStorage.getItem(localStorageKey));

    // Verifica se há progresso e questões a serem restauradas
    if (progresso && progresso.questoes && progresso.questoes.length > 0) {
        renderizarQuestoes(progresso.questoes);

        // Garantir que as alternativas sejam restauradas
        if (progresso.respostasSelecionadas) {
            Object.entries(progresso.respostasSelecionadas).forEach(([questaoId, alternativaId]) => {
                var input = document.querySelector(`input[name="alternativa-${questaoId}"][value="${alternativaId}"]`);
                if (input) input.checked = true; // Marca a alternativa salva
            });
        }

        // Emitir alerta informando que o progresso foi restaurado apenas se houver questões
        alert("Seu progresso foi restaurado!");
    } else {
        console.log("Nenhum progresso salvo encontrado ou progresso vazio.");
    }
}

    // Limpar progresso do usuário logado
    function limparProgresso() {
        localStorage.removeItem(localStorageKey);
    }

    if (exportarAtividadeBtn) {
    exportarAtividadeBtn.addEventListener("click", function () {
        alert("Botão temporariamente desabilitado.");
        // var questoesFiltradas = JSON.parse(localStorage.getItem("questoesAtuais"));

        //  if (!questoesFiltradas || !questoesFiltradas.questoes.length) {
            //  alert("Nenhuma questão encontrada para exportar.");
            //  return;
        //  }

        // Extrair IDs das questões filtradas
        //  var questoesIds = questoesFiltradas.questoes.map((q) => q.id);

        // varruir os parâmetros para envio
        //  var params = new URLSearchParams({ questoes: questoesIds });

        //  var url = `{% url 'exportar_atividade' %}?${params.toString()}`;

        // Abrir o PDF gerado
        //  window.open(url, '_blank');
    });
}


function exibirResumo(questoes) {
    var questoesContainer = document.getElementById("questoes-container");
    var acertosContainer = document.getElementById("acertos-container");
    var numeroAcertos = document.getElementById("numero-acertos");
    var totalQuestoes = document.getElementById("total-questoes");

    if (!questoes || questoes.length === 0) {
        questoesContainer.innerHTML = `
            <p style="color: white; text-align: center; font-size: 1.2rem;">
                Nenhuma questão encontrada. Você pode ter esquecido de marcar.
            </p>`;
        return;
    }

    // Calcular número de acertos
    var acertos = questoes.filter((questao) => {
        return questao.alternativas.some(
            (alt) => alt.id === questao.alternativa_selecionada && alt.correta
        );
    }).length;

    // Atualizar o texto no container de acertos
    numeroAcertos.textContent = acertos;
    totalQuestoes.textContent = questoes.length;

    // Exibir o container de acertos
    acertosContainer.classList.remove("hidden");
    acertosContainer.style.display = "block";

    questoesContainer.innerHTML = ""; // Limpar o container

    // Renderizar as questões do resumo
    questoes.forEach((questao, index) => {
        var resolucaoID = `resolucao-${index}`;
        var temResolucao = questao.resolucao && questao.resolucao.trim();
        var resolucaoTexto = temResolucao ? questao.resolucao : "Nenhuma resolução disponível.";

        var questaoElement = `
            <div class="questao-item">
                <h3>
                    Questão ${index + 1}
                    <button class="favorite-button" data-questao-id="${questao.id}" aria-label="Favoritar">
                        <img src="${questao.favoritada ? '/static/assets/heart-filled.png' : '/static/assets/heart-outline.png'}" alt="Favoritar" class="heart-icon ${questao.favoritada ? 'favorited' : ''}">
                    </button>
                </h3>
                <p>${questao.descricao}</p>
                <ul>
                    ${questao.alternativas.map((alt) => {
                        let classe = "";
                        if (alt.id === questao.alternativa_selecionada && alt.correta) {
                            classe = "correta-selecionada";
                        } else if (alt.id === questao.alternativa_selecionada) {
                            classe = "errada-selecionada";
                        } else if (alt.correta) {
                            classe = "correta";
                        }

                        return `
                            <li class="${classe}">
                                <input type="radio" id="alt-${alt.id}" name="alternativa-${questao.id}" value="${alt.id}" disabled ${alt.id === questao.alternativa_selecionada ? "checked" : ""}>
                                <label for="alt-${alt.id}">${alt.descricao}</label>
                            </li>`;
                    }).join("")}
                </ul>
                <div class="resolucao">
                    <h3 style="display: flex; justify-content: space-between; align-items: center;">
                        Resolução:
                        <button class="toggle-visibility" data-target="${resolucaoID}">
                            <img class="eye-show" src="{% static 'assets/eye-show.svg' %}" alt="Mostrar" style="display: none;">
                            <img class="eye-off" src="{% static 'assets/eye-off.svg' %}" alt="Esconder" style="display: inline;">
                        </button>
                    </h3>
                    <div id="${resolucaoID}" class="resolucao-content" style="display: none;">
                        ${resolucaoTexto}
                    </div>
                </div>
            </div>`;
        
        questoesContainer.insertAdjacentHTML("beforeend", questaoElement);
    });

    // Reativar MathJax, se necessário
    if (window.MathJax) {
        MathJax.typeset();
    }

    carregarFavoritosLocalStorage();

    // Ativar funcionalidade do botão de favoritar
    ativarFavoritarQuestoes();

    // Ativar eventos de visibilidade para os botões
    ativarBotoesVisibilidade();
}

    function reportarQuestao(questaoId) {
    var descricao = prompt("Descreva o problema encontrado:");
    if (!descricao) return;

    fetch("/aluno/praticar/reportar_questao/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
        },
        body: JSON.stringify({ questao_id: questaoId, descricao }),
    })
    .then((response) => response.json())
    .then((data) => alert(data.message || "Relatório enviado com sucesso!"))
    .catch((error) => console.error("Erro ao reportar problema:", error));
}

// Função para finalizar atividade após confirmação
function finalizarAtividadeConfirmada() {
    var respostas = [];
    document.querySelectorAll("input[type='radio']:checked").forEach((input) => {
        var questaoId = input.name.split("-")[1];
        var alternativaId = input.value;

        respostas.push({ questao_id: questaoId, alternativa_id: alternativaId });
    });

    fetch("{% url 'finalizar_atividade' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
        },
        body: JSON.stringify(respostas),
    })
        .then((response) => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            if (data.questoes_resolvidas) {
                // Salvar resumo no localStorage e indicar recarregamento para resumo
                localStorage.setItem("resumoAtividade", JSON.stringify({
                    questoes: data.questoes_resolvidas,
                }));
                localStorage.setItem("exibirResumo", "true");

                // Limpar progresso salvo após finalizar
                localStorage.removeItem(localStorageKey);

                // Atualize a interface sem recarregar imediatamente
                carregarResumo();
            }
        })
        .catch((error) => console.error("Erro ao finalizar a atividade:", error));
}



// Configurar o modal de confirmação
function configurarModalFinalizarAtividade() {
    var finalizarModal = document.getElementById("confirm-finalize-modal");
    var closeFinalizeModal = document.getElementById("close-finalize-modal");
    var confirmFinalizeBtn = document.getElementById("confirm-finalize-btn");

    document.addEventListener("click", (event) => {
    if (event.target && event.target.id === "finalizar-atividade") {
        event.preventDefault(); // Impede comportamento padrão
        var finalizarModal = document.getElementById("confirm-finalize-modal");
        if (finalizarModal) {
            finalizarModal.style.display = "block"; // Exibe o modal
        }
    }
});


    // Fechar modal ao clicar no "X"
    closeFinalizeModal?.addEventListener("click", () => {
        if (finalizarModal) {
            finalizarModal.style.display = "none";
        }
    });

    // Fechar modal ao clicar fora do conteúdo
    window.addEventListener("click", (event) => {
        if (event.target === finalizarModal) {
            finalizarModal.style.display = "none";
        }
    });

    confirmFinalizeBtn?.addEventListener("click", function (event) {
    event.preventDefault(); // Impede envio/recarregamento
    finalizarAtividadeConfirmada(); // Finaliza a atividade após confirmação

    // Força a barra de rolagem para o topo da página
    document.documentElement.scrollTop = 0; // Para navegadores modernos
    document.body.scrollTop = 0; // Para compatibilidade com navegadores mais antigos
    document.querySelector('html').scrollTop = 0; // Força o scroll no elemento <html>
    
    var finalizarModal = document.getElementById("confirm-finalize-modal");
    if (finalizarModal) {
        finalizarModal.style.display = "none"; // Fecha o modal
    }
});


}


// Configurar eventos do botão "Finalizar Atividade"
function configurarEventosBotaoFinalizar(finalizarBtn) {
    var finalizarModal = document.getElementById("confirm-finalize-modal");
    var closeFinalizeModal = document.getElementById("close-finalize-modal");
    var confirmFinalizeBtn = document.getElementById("confirm-finalize-btn");

    // Exibir modal ao clicar no botão "Finalizar Atividade"
    finalizarBtn.addEventListener("click", function () {
        if (finalizarModal) {
            finalizarModal.style.display = "block"; // Exibe o modal
        }
    });

    // Fechar o modal ao clicar no "X"
    closeFinalizeModal?.addEventListener("click", function () {
        if (finalizarModal) {
            finalizarModal.style.display = "none"; // Fecha o modal
        }
    });

    // Fechar o modal ao clicar fora do conteúdo
    window.addEventListener("click", function (event) {
        if (event.target === finalizarModal) {
            finalizarModal.style.display = "none"; // Fecha o modal
        }
    });

    // Confirmar finalização ao clicar no botão "Sim"
    confirmFinalizeBtn?.addEventListener("click", function () {
        if (finalizarModal) {
            finalizarModal.style.display = "none"; // Fecha o modal
        }
        finalizarAtividadeConfirmada(); // Chama a função para finalizar a atividade
    });
}

// Adicionar dinamicamente o botão "Finalizar Atividade"
function adicionarBotaoFinalizarAtividade() {
    var questoesContainer = document.getElementById("questoes-container");

    // Verificar se o botão já existe para evitar duplicação
    if (!document.getElementById("finalizar-atividade")) {
        var finalizarBtn = document.createElement("button");
        finalizarBtn.id = "finalizar-atividade";
        finalizarBtn.className = "btn btn-save";
        finalizarBtn.textContent = "Finalizar Atividade";

        // Adiciona o botão ao container de questões
        questoesContainer.insertAdjacentElement("beforeend", finalizarBtn);
    }
}


// Função para ativar visibilidade das resoluções no container
function ativarBotoesVisibilidade() {
    // Seleciona todos os botões de visibilidade dentro do container de questões
    document.querySelectorAll(".toggle-visibility").forEach(button => {
        button.addEventListener("click", function () {
            var targetID = this.dataset.target;
            var targetElement = document.getElementById(targetID);
            var eyeShow = this.querySelector(".eye-show");
            var eyeOff = this.querySelector(".eye-off");

            if (targetElement) {
                // Alterna visibilidade do conteúdo
                if (targetElement.style.display === "none" || targetElement.style.display === "") {
                    targetElement.style.display = "block";
                    eyeShow.style.display = "inline";
                    eyeOff.style.display = "none";
                } else {
                    targetElement.style.display = "none";
                    eyeShow.style.display = "none";
                    eyeOff.style.display = "inline";
                }
            }
        });
    });
}


function salvarRespostas() {
    var respostas = [];
    document.querySelectorAll("input[type='radio']:checked").forEach((input) => {
        var questaoId = input.name.split("-")[1];
        var alternativaId = input.value;

        respostas.push({ questao_id: questaoId, alternativa_id: alternativaId });
    });

    fetch("{% url 'registrar_resposta' %}", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
    },
    body: JSON.stringify(respostas), // 
})
.then((response) => response.json())
.then((data) => alert(data.message || "Respostas salvas com sucesso!"))
.catch((error) => console.error("Erro ao salvar respostas:", error));

}

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function atualizarFavoritosLocalStorage(questaoId, favoritada) {
    const favoritos = JSON.parse(localStorage.getItem("favoritos")) || {};

    if (favoritada) {
        favoritos[questaoId] = true; // Adiciona como favorito
    } else {
        delete favoritos[questaoId]; // Remove dos favoritos
    }

    localStorage.setItem("favoritos", JSON.stringify(favoritos));
}

function ativarFavoritarQuestoes() {
    document.querySelectorAll(".favorite-button").forEach(button => {
        button.addEventListener("click", function () {
            const questaoId = this.dataset.questaoId.trim();
            const heartIcon = this.querySelector(".heart-icon");

            fetch(`/aluno/favoritar_questao/${encodeURIComponent(questaoId)}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value,
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Atualizar o estado visual
                        const favoritos = JSON.parse(localStorage.getItem("favoritos")) || {};

                        if (data.favoritada) {
                            heartIcon.src = "/static/assets/heart-filled.png";
                            heartIcon.classList.add("favorited");
                            favoritos[questaoId] = true; // Adiciona ao localStorage
                        } else {
                            heartIcon.src = "/static/assets/heart-outline.png";
                            heartIcon.classList.remove("favorited");
                            delete favoritos[questaoId]; // Remove do localStorage
                        }

                        // Salvar estado atualizado
                        localStorage.setItem("favoritos", JSON.stringify(favoritos));
                    } else {
                        console.error("Erro ao atualizar favoritamento:", data.error);
                    }
                })
                .catch(error => console.error("Erro ao favoritar questão:", error));
        });
    });
}

function carregarFavoritosLocalStorage() {
    const favoritos = JSON.parse(localStorage.getItem("favoritos")) || {};

    document.querySelectorAll(".favorite-button").forEach(button => {
        const questaoId = button.dataset.questaoId.trim();
        const heartIcon = button.querySelector(".heart-icon");

        if (favoritos[questaoId]) {
            heartIcon.src = "/static/assets/heart-filled.png";
            heartIcon.classList.add("favorited");
        } else {
            heartIcon.src = "/static/assets/heart-outline.png";
            heartIcon.classList.remove("favorited");
        }
    });
}


function salvarFavoritosLocalStorage(questoes) {
    const favoritos = {};
    questoes.forEach((questao) => {
        favoritos[questao.id] = questao.favoritada;
    });
    localStorage.setItem("favoritos", JSON.stringify(favoritos));
}

// Garantir que os eventos sejam associados após a renderização
function renderizarQuestoes(questoes, isResumo = false) {
    salvarFavoritosLocalStorage(questoes);
    var questoesContainer = document.getElementById("questoes-container");
    var whiteSpace = document.getElementById("white-space");
    var acertosContainer = document.getElementById("acertos-container");

    // Ocultar o resumo ao gerar uma nova atividade
    if (acertosContainer) {
        acertosContainer.style.display = "none";
        acertosContainer.classList.add("hidden");
    }

    // Limpar o container de questões
    questoesContainer.innerHTML = "";

    // Exibir mensagem caso não existam questões
    if (!questoes || questoes.length === 0) {
        questoesContainer.style.display = "block";
        questoesContainer.innerHTML = `
            <p style="color: white; text-align: center; font-size: 1.2rem;">
                Não há questões para o filtro selecionado.
            </p>`;
        return;
    }

    questoesContainer.innerHTML = ""; // Limpa o container

    questoes.forEach((questao, index) => {
        var resolucaoID = `resolucao-${index}`;
        var questaoHTML = `
        <div class="questao-item">
            <h3>
                Questão ${index + 1}
                <button class="favorite-button" data-questao-id="${questao.id}" aria-label="Favoritar">
                    <img src="${questao.favoritada ? '/static/assets/heart-filled.png' : '/static/assets/heart-outline.png'}" alt="Favoritar" class="heart-icon ${questao.favoritada ? 'favorited' : ''}">
                </button>
            </h3>
            <p>${questao.descricao}</p>
            <ul>
                ${questao.alternativas.map(alt => `
                    <li>
                        <input type="radio" id="alt-${alt.id}" name="alternativa-${questao.id}" value="${alt.id}">
                        <label for="alt-${alt.id}">${alt.descricao}</label>
                    </li>
                `).join("")}
            </ul>
            <div class="resolucao">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    Resolução:
                    <button class="toggle-visibility" data-target="${resolucaoID}">
                        <img class="eye-show" src="{% static 'assets/eye-show.svg' %}" alt="Mostrar" style="display: none;">
                        <img class="eye-off" src="{% static 'assets/eye-off.svg' %}" alt="Esconder" style="display: inline;">
                    </button>
                </h3>
                <div id="${resolucaoID}" class="resolucao-content" style="display: none;">
                    ${questao.resolucao || "Nenhuma resolução disponível."}
                </div>
            </div>
        </div>`;
        questoesContainer.insertAdjacentHTML("beforeend", questaoHTML);
    });

    // Ocultar o white space se as questões forem geradas
    if (whiteSpace) {
        whiteSpace.style.display = "none";
    }

    // Tornar o container de questões visível
    questoesContainer.style.display = "block";

    // Ativar funcionalidade do botão de favoritar
    ativarFavoritarQuestoes();

    // Adicionar dinamicamente o botão "Finalizar Atividade"
    adicionarBotaoFinalizarAtividade();

    // Ativar os botões de visibilidade para resoluções
    ativarBotoesVisibilidade();

    // Chamar função para carregar questões favoritadas
    carregarFavoritosLocalStorage();

    // Reprocessar o MathJax para renderizar fórmulas matemáticas, se necessário
    if (window.MathJax) {
        MathJax.typeset();
    }
}

    var quantidade = quantidadeInput.value.trim();

    function carregarAlternativas() {
    var respostasSalvas = JSON.parse(localStorage.getItem("respostasSelecionadas")) || {};
    Object.entries(respostasSalvas).forEach(([questaoId, alternativaId]) => {
        var input = document.querySelector(`input[name="alternativa-${questaoId}"][value="${alternativaId}"]`);
        if (input) input.checked = true;
    });
}

function carregarRespostasSalvas() {
        var respostasSalvas = JSON.parse(localStorage.getItem("respostasSelecionadas")) || {};
        Object.entries(respostasSalvas).forEach(([questaoId, alternativaId]) => {
            var input = document.querySelector(`input[name="alternativa-${questaoId}"][value="${alternativaId}"]`);
            if (input) input.checked = true;
        });
    }

function carregarQuestoesSalvas() {
    var questoesSalvas = JSON.parse(localStorage.getItem("questoesAtuais"));
    if (questoesSalvas && questoesSalvas.questoes && questoesSalvas.questoes.length > 0) {
        console.log("Carregando questões salvas do localStorage:", questoesSalvas);
        renderizarQuestoes(questoesSalvas.questoes);
        carregarRespostasSalvas();
    } else {
        // Mostra o white space se nenhuma questão estiver salva
        if (whiteSpace) {
            whiteSpace.style.display = "block";
        }
        console.log("Nenhuma questão salva encontrada no localStorage.");
    }
}

// Verificar se há resumo salvo no localStorage ao carregar a página
function carregarResumo() {
    var exibirResumoFlag = localStorage.getItem("exibirResumo") === "true";
    var resumoAtividade = JSON.parse(localStorage.getItem("resumoAtividade"));

    if (exibirResumoFlag && resumoAtividade && resumoAtividade.questoes) {
        exibirResumo(resumoAtividade.questoes);

        // Tornar visível o container de resumo
        var acertosContainer = document.getElementById("acertos-container");
        if (acertosContainer) {
            acertosContainer.classList.remove("hidden");
            acertosContainer.style.display = "block";
        }

        // Redirecionar para o topo da página
        setTimeout(() => {
            document.documentElement.scrollTo({ top: 0, behavior: "smooth" });
        }, 100); // Pequeno atraso para garantir que o DOM esteja atualizado

        // Limpar indicador e resumo do localStorage
        localStorage.removeItem("exibirResumo");
        localStorage.removeItem("resumoAtividade");
    } else {
        carregarProgresso(); // Restaurar progresso normalmente
    }
}


function inicializarPagina() {
    var questoesContainer = document.getElementById("questoes-container");
    var whiteSpace = document.getElementById("white-space");

    // Tenta carregar o progresso salvo
    carregarProgresso();

    // Se nenhuma questão foi carregada, exibe o espaço em branco
    var progresso = JSON.parse(localStorage.getItem(localStorageKey));
    if (!progresso || !progresso.questoes || progresso.questoes.length === 0) {
        console.log("Nenhum progresso salvo. Exibindo espaço em branco.");
        whiteSpace.style.display = "flex"; // Mostra o espaço em branco
        questoesContainer.style.display = "none"; // Oculta o container de questões
    }
}

document.addEventListener("change", (event) => {
    if (event.target.matches("input[type='radio']")) {
        var progresso = JSON.parse(localStorage.getItem(localStorageKey));
        var questoes = progresso ? progresso.questoes : [];
        salvarProgresso(questoes); // Atualiza o progresso salvo
    }
});

    function validarQuantidade() {
        var quantidade = quantidadeInput.value.trim();
        if (!quantidade || isNaN(quantidade) || quantidade <= 0 || quantidade > 50) {
            alert("Por favor, insira um número válido de questões (1 a 50).");
            return false;
        }
        return true;
    }

// Declarar salvarAlternativas antes de adicionar eventos
function salvarAlternativas() {
        var respostasSelecionadas = {};
        document.querySelectorAll("input[type='radio']:checked").forEach((input) => {
            var questaoId = input.name.split("-")[1];
            respostasSelecionadas[questaoId] = input.value;
        });
        localStorage.setItem("respostasSelecionadas", JSON.stringify(respostasSelecionadas));
    }

    

    // Faz a requisição para o backend
    var params = new URLSearchParams(new FormData(document.querySelector("#filtro-questoes-form")));
    formData.forEach((value, key) => {
        if (value) params.append(key, value); // Adiciona apenas parâmetros válidos
    });

    function buscarQuestoes() {
    var form = document.querySelector("#filtro-questoes-form");
    var params = new URLSearchParams(new FormData(form));

    // Limpar progresso salvo antes de uma nova busca
    localStorage.removeItem(localStorageKey);

    // Adicionar filtro de status
    var statusFilters = [];
    document.querySelectorAll("input[name='status']:checked").forEach((checkbox) => {
        statusFilters.push(checkbox.value);
    });

    if (statusFilters.length > 0) {
        params.set("status", statusFilters.join(",")); // Atualiza o parâmetro com os valores selecionados
    } else {
        params.delete("status"); // Remove o parâmetro se nenhum filtro estiver selecionado
    }

    // Garantir que o campo de busca seja enviado
    var buscaInput = form.querySelector("#busca-questoes");
    if (buscaInput && buscaInput.value.trim()) {
        params.set("busca", buscaInput.value.trim()); // Garante que o valor do campo seja enviado
    } else {
        params.delete("busca"); // Remove o parâmetro de busca se estiver vazio
    }

    // Garantir que a quantidade seja válida
    var quantidade = parseInt(document.getElementById("quantidade").value.trim());
    if (isNaN(quantidade) || quantidade <= 0 || quantidade > 50) {
        alert("Por favor, insira um número válido de questões (1 a 50).");
        return;
    }

    // Fazer a requisição para o backend
    fetch(`/aluno/api/questoes?${params}`)
        .then((response) => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            // Limpar interface e progresso local antes de renderizar novos dados
            var questoesContainer = document.getElementById("questoes-container");
            questoesContainer.innerHTML = ""; // Limpa o container para evitar sobreposição
            var questoesFiltradas = data.questoes.slice(0, quantidade);

            if (questoesFiltradas.length === 0) {
                // Exibir mensagem de "Nenhuma questão encontrada"
                questoesContainer.innerHTML = `
                    <p style="color: white; text-align: center; font-size: 1.2rem;">
                        Nenhuma questão encontrada para os filtros aplicados.
                    </p>`;
                questoesContainer.style.display = "block";
                localStorage.removeItem(localStorageKey); // Remove cache vazio
                return;
            }

            // Renderizar questões filtradas
            renderizarQuestoes(questoesFiltradas);

            // Salvar progresso no localStorage
            salvarProgresso(questoesFiltradas);
        })
        .catch((error) => {
            console.error("Erro ao buscar questões:", error);
        });
}


    // Função para exibir mensagem "Nenhuma questão encontrada"
function exibirMensagemSemQuestoes() {
    var questoesContainer = document.getElementById("questoes-container");

    // Exibir mensagem no container de questões
    questoesContainer.innerHTML = `
        <p style="color: white; text-align: center; font-size: 1.2rem;">
            Nenhuma questão encontrada para os filtros aplicados.
        </p>`;

    // Tornar o container visível
    questoesContainer.style.display = "block";
}

        // Reativar funcionalidade de botão "visualizar resolução"
        document.querySelectorAll(".toggle-visibility").forEach(button => {
        button.addEventListener("click", () => {
            var target = document.getElementById(button.dataset.target);
            var eyeshow = button.querySelector(".eye-show");
            var eyeoff = button.querySelector(".eye-off");

            if (target.style.display === "none") {
                target.style.display = "block";
                eyeshow.style.display = "block";
                eyeoff.style.display = "none";
            } else {
                target.style.display = "none";
                eyeshow.style.display = "none";
                eyeoff.style.display = "block";
            }
        });
    });



    toggleButtons.forEach((button) => {
        button.addEventListener("click", function () {
            var resolucao = button.closest(".questao-item").querySelector(".resolucao");
            if (resolucao.style.display === "none" || !resolucao.style.display) {
                resolucao.style.display = "block";
                button.classList.add("active");
            } else {
                resolucao.style.display = "none";
                button.classList.remove("active");
            }
        });
    });

    // Evento de mudança na disciplina
    disciplinaSelect.addEventListener("change", function () {
        var disciplinaId = this.value;

        // Limpa o conteúdo atual
        conteudoSelect.innerHTML = '<option value="">Todas</option>';
        conteudoSelect.disabled = true; // Desativa enquanto carrega

        if (disciplinaId) {
            // Busca os conteúdos relacionados à disciplina selecionada
            fetch(`/api/conteudos/${disciplinaId}/`)
                .then(response => response.json())
                .then(data => {
                    // Popula o select de conteúdos
                    if (data.length > 0) {
                        data.forEach(conteudo => {
                            var option = document.createElement("option");
                            option.value = conteudo.id;
                            option.textContent = conteudo.nome;
                            conteudoSelect.appendChild(option);
                        });
                        conteudoSelect.disabled = false; // Habilita após carregar
                    } else {
                        console.warn("Nenhum conteúdo encontrado para esta disciplina.");
                    }
                })
                .catch(error => {
                    console.error("Erro ao carregar conteúdos:", error);
                });
        } else {
            conteudoSelect.disabled = true; // Desativa se nenhuma disciplina for selecionada
        }
    });
    
    // Carregar tópicos ao mudar conteúdo
    conteudoSelect.addEventListener("change", function () {
    var conteudoId = this.value;

    if (conteudoId) {
        console.log(`Conteúdo selecionado: ${conteudoId}`);
        // Aqui você pode registrar ou usar o conteúdo selecionado
    } else {
        console.log("Nenhum conteúdo selecionado.");
    }
});


    // Lógica de "Mudar de Conta"
    // Função para renderizar as contas no modal
    function renderAccounts(accounts, currentEmail) {
        accountList.innerHTML = ""; // Limpar lista atual
        if (accounts.length === 0) {
            accountList.innerHTML = "<li class='empty'>Nenhuma conta adicionada.</li>";
        } else {
            accounts.forEach(account => {
                var listItem = document.createElement("li");
                listItem.textContent = account;
                listItem.setAttribute("data-email", account);

                // Se a conta for a atual
                if (account === currentEmail) {
                    listItem.textContent += " (atual)";
                    listItem.classList.add("current-account");

                    // Alerta ao clicar na conta atual
                    listItem.addEventListener("click", () => {
                        alert("Você já está logado com essa conta.");
                    });
                } else {
                    // Botão de remoção
                    var removeButton = document.createElement("button");
                    removeButton.textContent = "Remover";
                    removeButton.className = "btn-remove";

                    removeButton.addEventListener("click", event => {
                        event.stopPropagation(); // Impedir seleção acidental de conta
                        removeAccount(account);
                    });

                    listItem.appendChild(removeButton);

                    // Exibir modal de confirmação de mudança de conta
                    listItem.addEventListener("click", () => {
                        selectedEmail = account;
                        accountModal.style.display = "none";
                        accountConfirmationModal.style.display = "block";
                    });
                }

                accountList.appendChild(listItem);
            });
        }
    }

    // Buscar contas do backend
    function fetchAccounts() {
        fetch("/turmas/listar-contas/")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderAccounts(data.contas, data.conta_atual);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error("Erro ao buscar contas:", error));
    }

    // Remover conta
    function removeAccount(email) {
        fetch("/turmas/remover-conta/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value
            },
            body: JSON.stringify({ conta: email })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Conta removida com sucesso.");
                    fetchAccounts(); // Atualizar lista de contas
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error("Erro ao remover conta:", error));
    }

    addAccountButton.addEventListener("click", event => {
    event.preventDefault(); // Evita comportamento padrão (se necessário)
    var newAccount = newAccountInput.value.trim();
    if (!newAccount) {
        alert("Por favor, insira um e-mail válido.");
        return;
    }

    // Verifica se a conta já está na lista antes de adicionar
    fetch("/turmas/listar-contas/")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.contas.includes(newAccount)) {
                    alert("Essa conta já está na lista.");
                    newAccountInput.value = ""; // Limpar o campo de entrada
                    return;
                }

                // Adiciona a nova conta ao backend
                fetch("/turmas/mudar-conta/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value
                    },
                    body: JSON.stringify({ nova_conta: newAccount })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Conta adicionada com sucesso.");
                            newAccountInput.value = ""; // Limpar o campo de entrada
                            fetchAccounts(); // Atualizar lista de contas
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error("Erro ao adicionar conta:", error));
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error("Erro ao verificar contas existentes:", error));
});


    // Confirmar mudança de conta
    confirmChangeButton.addEventListener("click", () => {
        if (selectedEmail) {
            accountConfirmationModal.style.display = "none";
            window.location.href = `/auth/login/?email=${encodeURIComponent(selectedEmail)}`;
        }
    });

    // Abrir modal de contas
    changeAccountButton.addEventListener("click", () => {
        fetchAccounts();
        accountModal.style.display = "block";
    });

    // Fechar modal de contas ao clicar no "X"
    closeAccountModal.addEventListener("click", () => {
        accountModal.style.display = "none";
    });

    // Fechar modal de confirmação ao clicar no "X"
    closeAccountConfirmationModal.addEventListener("click", () => {
        accountConfirmationModal.style.display = "none";
    });

    // Fechar modal ao clicar fora dele
    window.addEventListener("click", event => {
        if (event.target === accountModal) {
            accountModal.style.display = "none";
        } else if (event.target === accountConfirmationModal) {
            accountConfirmationModal.style.display = "none";
        }
    });

    console.log("Botão 'Gerar atividade' encontrado e evento sendo configurado.");

    // Inicialmente, esconde o container de questões
    questoesContainer.style.display = "none";
    console.log("Container de questões:", questoesContainer);


    // Obter o formulário de filtro
    var filtroForm = document.querySelector("#filtro-questoes-form");
    if (!filtroForm) {
        console.error("O formulário '#filtro-questoes-form' não foi encontrado.");
        return;
    }

    // Evento de clique no botão "Gerar Atividade"
    gerarAtividadeBtn.addEventListener("click", function () {
        var quantidade = quantidadeInput.value.trim();
        if (!quantidade || isNaN(quantidade) || quantidade <= 0 || quantidade > 50) {
            alert("Por favor, insira um número válido de questões (1 a 50).");
            return;
        }

        buscarQuestoes();

        // Parâmetros para requisição de questões
        var filtroForm = document.querySelector("#filtro-questoes-form");
        var params = new URLSearchParams(new FormData(filtroForm));

        // Requisição para buscar as questões
        fetch("{% url 'buscar_questoes' %}?${params.toString()}")
            .then(response => {
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                return response.json();
            })
            .then(data => {
                var questoesFiltradas = data.questoes.slice(0, quantidade);
                renderizarQuestoes(questoesFiltradas);

                // Salva as questões no localStorage
                localStorage.setItem("questoesAtuais", JSON.stringify({ questoes: questoesFiltradas }));
                whiteSpace.style.display = "none"; // Oculta o espaço branco
            })
            .catch(error => console.error("Erro ao buscar questões:", error));
    });
    
    document.getElementById("gerar-atividade").addEventListener("click", () => {
        var quantidade = document.getElementById("quantidade").value.trim();
        if (!quantidade || isNaN(quantidade) || quantidade <= 0 || quantidade > 50) {
            alert("Por favor, insira um número válido de questões (1 a 50).");
            return;
        }

    buscarQuestoes(); // Chama a função que fará a busca
});


    // Adicionar evento para salvar respostas ao marcar alternativas
    document.addEventListener("change", (event) => {
        if (event.target.matches("input[type='radio']")) {
            salvarAlternativas();
        }
    });

    // Chama a inicialização ao carregar a página
    inicializarPagina();

    // Função para verificar se o formulário está válido
    function verificarFormulario() {
        var quantidadeValida = quantidadeInput.value >= 1 && quantidadeInput.value <= 50;
    }

    // Adiciona eventos de input no campo de quantidade
    quantidadeInput.addEventListener("input", verificarFormulario);

    // Inicializa o estado do botão
    verificarFormulario();


    document.addEventListener("change", (event) => {
        if (event.target.matches("input[type='radio']")) {
            salvarAlternativas();
        }
    });

    // Abrir modal ao clicar em "Finalizar atividade"
    if (finalizarAtividadeBtn) {
        finalizarAtividadeBtn.addEventListener("click", () => {
            finalizarModal.style.display = "block";
        });
    }

    // Fechar modal ao clicar no "X"
    closeFinalizarModal?.addEventListener("click", () => {
        finalizarModal.style.display = "none";
    });

    // Fechar modal ao clicar fora do conteúdo
    window.addEventListener("click", (event) => {
        if (event.target === finalizarModal) {
            finalizarModal.style.display = "none";
        }
    });

    // Abrir o modal ao clicar no botão "Limpar"
    clearButton.addEventListener("click", function (event) {
        event.preventDefault(); // Evita o comportamento padrão do botão
        clearModal.style.display = "block";
    });

    // Fechar o modal ao clicar no "X" ou fora do modal
    closeClearModal.addEventListener("click", function () {
        clearModal.style.display = "none";
    });

    window.addEventListener("click", function (event) {
        if (event.target === clearModal) {
            clearModal.style.display = "none";
        }
    });

    // Confirmar limpeza
    confirmClearButton.addEventListener("click", function () {
        // Limpar o localStorage
        localStorage.removeItem("questoesAtuais");
        localStorage.removeItem("respostasSelecionadas");

        // Recarregar a página para restaurar o estado inicial
        location.reload();
    });


    });
</script>