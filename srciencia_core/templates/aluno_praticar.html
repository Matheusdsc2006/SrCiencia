{% load static %}    
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>SR. Ciência - Turmas</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
            },
            svg: {
                fontCache: 'global',
            },
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>     
    <link rel="stylesheet" href="{% static 'css/praticar.css' %}">
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
</head>
<body>
    <main>
        <div class="container">
            <!-- Menu Lateral -->
            <aside class="sidebar">
                <div class="logo">
                    <img src="{% static 'assets/sr_ciencia.svg' %}" alt="SR. Ciência">
                </div>
                <nav>
                    <ul>
                        <li>
                            <a href="{% url 'pagina_inicial' %}">
                                <img src="{% static 'assets/home.svg' %}" alt="">Página inicial
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <img src="{% static 'assets/profile.svg' %}" alt="">Meu perfil
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'aluno_praticar' %}" class="active">
                                <img src="{% static 'assets/practice.svg' %}" alt="">Praticar
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'turmas' %}">
                                <img src="{% static 'assets/classes.svg' %}" alt="">Turmas
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <img src="{% static 'assets/forum.svg' %}" alt="">Fórum
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <img src="{% static 'assets/help.svg' %}" alt="">Ajuda
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'login' %}" class="logout">
                                <img src="{% static 'assets/logout.svg' %}" alt="">Sair
                            </a>
                        </li>
                    </ul>
                </nav>
            </aside>
    
            <!-- Cabeçalho -->
            <main class="main-container">
                <div class="header-container-inicio">
                    <div class="header-card">
                        <div class="user-info">
                            <div class="user-avatar">
                                <figure>
                                    <img src="{% static 'assets/user.avif' %}" alt="Usuário">
                                </figure>
                            </div>
                            <div>
                                <p class="user-name">{{ user.username }}</p>
                                <p class="user-email">{{ user.email }}</p>
                            </div>
                        </div>
                        <button id="change-account-btn" class="change-account">Mudar de conta</button>
                    </div>
                </div>
    
                <!-- Conteúdo da Página de Praticar -->
                <div class="header-container">
                    <h2 class="quest">Praticar</h2>
                </div>
    
                <!-- Filtros de Busca -->
                <form id="filtro-questoes-form" class="form-container">
                    <div class="form-group">
                        <label for="quantidade">
                            Quantidade de questões: <span style="color: red;">*</span>
                        </label>
                        <input type="number" id="quantidade" name="quantidade" placeholder="Máx. 50" min="1" max="50" required>
                    </div>
    
                    <div class="form-group">
                        <label for="disciplina">Disciplina:</label>
                        <select id="disciplina" name="disciplina">
                            <option value="">Todas</option>
                            {% for disciplina in disciplinas %}
                            <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
    
                    <div class="form-group">
                        <label for="conteudo">Conteúdo:</label>
                        <select id="conteudo" name="conteudo" disabled>
                            <option value="">Todos</option>
                        </select>
                    </div>
    
                    <div class="form-group">
                        <label for="dificuldade">Dificuldade:</label>
                        <select id="dificuldade" name="dificuldade">
                            <option value="">Todas</option>
                            <option value="1">Fácil</option>
                            <option value="2">Médio</option>
                            <option value="3">Difícil</option>
                        </select>
                    </div>
    
                    <div class="form-group">
                        <label>Status:</label>
                        <div class="status-options">
                            <label>
                                <input type="checkbox" name="status" value="nao_resolvidas"> Não resolvidas
                            </label>
                            <label>
                                <input type="checkbox" name="status" value="com_resolucao"> Com resolução
                            </label>
                            <label>
                                <input type="checkbox" name="status" value="que_errei"> Que errei
                            </label>
                        </div>
                    </div>
    
                    <div class="btn-group">
                        <button type="button" class="btn btn-save" id="gerar-atividade">Gerar atividade</button>
                        <button type="reset" class="btn btn-cancel">Limpar</button>
                    </div>
                </form>
    
                <!-- Área de feedback inicial -->
                <div id="white-space" class="hidden">
                    <h2 class="gerar">Aguardando filtro...</h2>
                </div>
    
                <!-- Conteúdo dinâmico das questões -->
                <section id="questoes-container">
                    <!-- Questões serão geradas aqui -->
                </section>
            </main>
        </div>
    </main>    

    <!-- Modal de Gerenciamento de Contas -->
    <div id="account-modal" class="modal">
        <div class="modal-content">
            <span id="close-account-modal" class="close-icon">&times;</span>
            <h2>Selecione ou remova uma conta</h2>
            <ul class="account-list"></ul>
            <form id="add-account-form">
                {% csrf_token %}
                <label for="new-account">E-mail:</label>
                <input type="email" id="new-account" placeholder="Digite um e-mail" required />
                <button id="add-account-btn" class="btn-confirm-sim" type="button">Adicionar Conta</button>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação para Mudar de Conta -->
    <div id="account-confirmation-modal" class="modal">
        <div class="modal-content">
            <span id="close-account-confirmation-modal" class="close-icon">&times;</span>
            <h2>Deseja realmente mudar de conta?</h2>
            <p style="font-size: 20px;">Você será redirecionado para a tela de login.</p>
            <div class="modal-actions">
                <button id="confirm-change-btn" class="btn-confirm-sim" style="font-weight: 400;">Sim</button>
            </div>
        </div>
    </div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    // Referências dos elementos
    var disciplinaSelect = document.getElementById("disciplina");
    var conteudoSelect = document.getElementById("conteudo");
    var gerarAtividadeBtn = document.getElementById("gerar-atividade");
    var questoesContainer = document.getElementById("questoes-container");
    var quantidadeInput = document.getElementById("quantidade");
    var whiteSpace = document.getElementById("white-space");
    var toggleButtons = document.querySelectorAll(".toggle-visibility");
    var formData = new FormData(document.querySelector("#filtro-questoes-form"));

    var accountModal = document.getElementById("account-modal");
    var accountConfirmationModal = document.getElementById("account-confirmation-modal");
    var changeAccountButton = document.getElementById("change-account-btn");
    var closeAccountModal = document.getElementById("close-account-modal");
    var closeAccountConfirmationModal = document.getElementById("close-account-confirmation-modal");
    var confirmChangeButton = document.getElementById("confirm-change-btn");
    var addAccountButton = document.getElementById("add-account-btn");
    var accountList = document.querySelector(".account-list");
    var newAccountInput = document.getElementById("new-account");
    let selectedEmail = null;

    questoesContainer.innerHTML = "";
    
    // Função para ativar a visibilidade das resoluções
    function ativarBotoesVisibilidade() {
        document.querySelectorAll(".toggle-visibility").forEach(button => {
            button.addEventListener("click", function () {
                var targetId = button.dataset.target; // ID do conteúdo da resolução
                var target = document.getElementById(targetId); // Elemento da resolução
                var eyeShow = button.querySelector(".eye-show"); // Ícone de olho aberto
                var eyeOff = button.querySelector(".eye-off"); // Ícone de olho fechado

                if (!target || !eyeShow || !eyeOff) {
                    console.warn("Elementos necessários para visibilidade não encontrados:", button);
                    return;
                }

                // Alterna entre mostrar e esconder o conteúdo da resolução
                if (target.style.display === "none" || target.style.display === "") {
                    target.style.display = "block"; // Mostra a resolução
                    eyeShow.style.display = "inline"; // Mostra o ícone de olho aberto
                    eyeOff.style.display = "none"; // Esconde o ícone de olho fechado
                } else {
                    target.style.display = "none"; // Esconde a resolução
                    eyeShow.style.display = "none"; // Esconde o ícone de olho aberto
                    eyeOff.style.display = "inline"; // Mostra o ícone de olho fechado
                }
            });
        });
    }

    // Faz a requisição para o backend
    var params = new URLSearchParams();
    formData.forEach((value, key) => {
        if (value) params.append(key, value); // Adiciona apenas parâmetros válidos
    });

    fetch(`/aluno/praticar/api/questoes?${params.toString()}`)

        .then(response => {
            if (!response.ok) throw new Error("Erro ao carregar as questões");
            return response.json();
        })
        .then(data => {
        questoesContainer.innerHTML = ""; 
        if (!data.questoes || !Array.isArray(data.questoes) || !data.questoes.length) {
            questoesContainer.innerHTML = "<p>Nenhuma questão encontrada.</p>";
            return;
        }


            // Renderizar questões
            data.questoes.forEach((questao, index) => {
                var questaoElement = document.createElement("div");
                questaoElement.className = "questao-item";
                questaoElement.innerHTML = `
                    <h3>Questão ${index + 1}</h3>
                    <p>${questao.descricao}</p>
                    <ul>
                        ${questao.alternativas
                            .map(
                                alt => `
                                <li>
                                    <input type="radio" id="alt-${alt.id}" name="alternativa-${questao.id}" value="${alt.id}">
                                    <label for="alt-${alt.id}">${alt.descricao}</label>
                                </li>
                            `
                            )
                            .join("")}
                    </ul>
                    <div class="resolucao">
                        <h4>
                            Resolução:
                            <button class="toggle-visibility" data-target="resolucao-${index}">
                                <img src="{% static 'assets/eye-off.svg' %}" alt="Fechar" class="eye-off">
                                <img src="{% static 'assets/eye-show.svg' %}" alt="Abrir" class="eye-show" style="display: none;">
                            </button>
                        </h4>
                        <div id="resolucao-${index}" class="resolucao-content" style="display: none;">
                            ${questao.resolucao || "Nenhuma resolução disponível."}
                        </div>
                    </div>
                `;
                questoesContainer.appendChild(questaoElement);
            });

            // Reativar funcionalidade de botão "visualizar resolução"
            document.querySelectorAll(".toggle-visibility").forEach(button => {
                button.addEventListener("click", () => {
                    var target = document.getElementById(button.dataset.target);
                    var eyeshow = button.querySelector(".eye-show");
                    var eyeoff = button.querySelector(".eye-off");

                    if (target.style.display === "none") {
                        target.style.display = "block";
                        eyeshow.style.display = "block";
                        eyeoff.style.display = "none";
                    } else {
                        target.style.display = "none";
                        eyeshow.style.display = "none";
                        eyeoff.style.display = "block";
                    }
                });
            });
        })
        .catch(error => console.error("Erro:", error));

    toggleButtons.forEach((button) => {
        button.addEventListener("click", function () {
            var resolucao = button.closest(".questao-item").querySelector(".resolucao");
            if (resolucao.style.display === "none" || !resolucao.style.display) {
                resolucao.style.display = "block";
                button.classList.add("active");
            } else {
                resolucao.style.display = "none";
                button.classList.remove("active");
            }
        });
    });

    // Certifique-se de que os elementos existem
    if (!disciplinaSelect || !conteudoSelect) {
        console.warn("Elementos necessários ('disciplina' ou 'conteudo') não encontrados na página.");
        return;
    }

    // Evento de mudança na disciplina
    disciplinaSelect.addEventListener("change", function () {
        var disciplinaId = this.value;

        // Limpa o conteúdo atual
        conteudoSelect.innerHTML = '<option value="">Todas</option>';
        conteudoSelect.disabled = true; // Desativa enquanto carrega

        if (disciplinaId) {
            // Busca os conteúdos relacionados à disciplina selecionada
            fetch(`/api/conteudos/${disciplinaId}/`)
                .then(response => response.json())
                .then(data => {
                    // Popula o select de conteúdos
                    if (data.length > 0) {
                        data.forEach(conteudo => {
                            var option = document.createElement("option");
                            option.value = conteudo.id;
                            option.textContent = conteudo.nome;
                            conteudoSelect.appendChild(option);
                        });
                        conteudoSelect.disabled = false; // Habilita após carregar
                    } else {
                        console.warn("Nenhum conteúdo encontrado para esta disciplina.");
                    }
                })
                .catch(error => {
                    console.error("Erro ao carregar conteúdos:", error);
                });
        } else {
            conteudoSelect.disabled = true; // Desativa se nenhuma disciplina for selecionada
        }
    });
    
    // Carregar tópicos ao mudar conteúdo
    conteudoSelect.addEventListener("change", function () {
    var conteudoId = this.value;

    if (conteudoId) {
        console.log(`Conteúdo selecionado: ${conteudoId}`);
        // Aqui você pode registrar ou usar o conteúdo selecionado
    } else {
        console.log("Nenhum conteúdo selecionado.");
    }
});


    // Lógica de "Mudar de Conta"
    // Função para renderizar as contas no modal
    function renderAccounts(accounts, currentEmail) {
        accountList.innerHTML = ""; // Limpar lista atual
        if (accounts.length === 0) {
            accountList.innerHTML = "<li class='empty'>Nenhuma conta adicionada.</li>";
        } else {
            accounts.forEach(account => {
                var listItem = document.createElement("li");
                listItem.textContent = account;
                listItem.setAttribute("data-email", account);

                // Se a conta for a atual
                if (account === currentEmail) {
                    listItem.textContent += " (atual)";
                    listItem.classList.add("current-account");

                    // Alerta ao clicar na conta atual
                    listItem.addEventListener("click", () => {
                        alert("Você já está logado com essa conta.");
                    });
                } else {
                    // Botão de remoção
                    var removeButton = document.createElement("button");
                    removeButton.textContent = "Remover";
                    removeButton.className = "btn-remove";

                    removeButton.addEventListener("click", event => {
                        event.stopPropagation(); // Impedir seleção acidental de conta
                        removeAccount(account);
                    });

                    listItem.appendChild(removeButton);

                    // Exibir modal de confirmação de mudança de conta
                    listItem.addEventListener("click", () => {
                        selectedEmail = account;
                        accountModal.style.display = "none";
                        accountConfirmationModal.style.display = "block";
                    });
                }

                accountList.appendChild(listItem);
            });
        }
    }

    // Buscar contas do backend
    function fetchAccounts() {
        fetch("/turmas/listar-contas/")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderAccounts(data.contas, data.conta_atual);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error("Erro ao buscar contas:", error));
    }

    // Remover conta
    function removeAccount(email) {
        fetch("/turmas/remover-conta/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value
            },
            body: JSON.stringify({ conta: email })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Conta removida com sucesso.");
                    fetchAccounts(); // Atualizar lista de contas
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error("Erro ao remover conta:", error));
    }

    addAccountButton.addEventListener("click", event => {
    event.preventDefault(); // Evita comportamento padrão (se necessário)
    var newAccount = newAccountInput.value.trim();
    if (!newAccount) {
        alert("Por favor, insira um e-mail válido.");
        return;
    }

    // Verifica se a conta já está na lista antes de adicionar
    fetch("/turmas/listar-contas/")
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.contas.includes(newAccount)) {
                    alert("Essa conta já está na lista.");
                    newAccountInput.value = ""; // Limpar o campo de entrada
                    return;
                }

                // Adiciona a nova conta ao backend
                fetch("/turmas/mudar-conta/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.querySelector("[name='csrfmiddlewaretoken']").value
                    },
                    body: JSON.stringify({ nova_conta: newAccount })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Conta adicionada com sucesso.");
                            newAccountInput.value = ""; // Limpar o campo de entrada
                            fetchAccounts(); // Atualizar lista de contas
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error("Erro ao adicionar conta:", error));
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error("Erro ao verificar contas existentes:", error));
});


    // Confirmar mudança de conta
    confirmChangeButton.addEventListener("click", () => {
        if (selectedEmail) {
            accountConfirmationModal.style.display = "none";
            window.location.href = `/auth/login/?email=${encodeURIComponent(selectedEmail)}`;
        }
    });

    // Abrir modal de contas
    changeAccountButton.addEventListener("click", () => {
        fetchAccounts();
        accountModal.style.display = "block";
    });

    // Fechar modal de contas ao clicar no "X"
    closeAccountModal.addEventListener("click", () => {
        accountModal.style.display = "none";
    });

    // Fechar modal de confirmação ao clicar no "X"
    closeAccountConfirmationModal.addEventListener("click", () => {
        accountConfirmationModal.style.display = "none";
    });

    // Fechar modal ao clicar fora dele
    window.addEventListener("click", event => {
        if (event.target === accountModal) {
            accountModal.style.display = "none";
        } else if (event.target === accountConfirmationModal) {
            accountConfirmationModal.style.display = "none";
        }
    });

    if (!gerarAtividadeBtn || !quantidadeInput || !questoesContainer) {
        console.error("Elementos necessários não foram encontrados na página!");
        return;
    }

    console.log("Botão 'Gerar atividade' encontrado e evento sendo configurado.");

    if (!gerarAtividadeBtn || !quantidadeInput || !questoesContainer) {
        console.error("Elementos necessários não foram encontrados na página!");
        return;
    }

    console.log("Botão 'Gerar atividade' encontrado e evento sendo configurado.");

    if (!gerarAtividadeBtn || !quantidadeInput || !questoesContainer) {
        console.error("Elementos necessários não foram encontrados na página!");
        return;
    }

    console.log("Botão 'Gerar atividade' encontrado e evento sendo configurado.");

    // Inicialmente, esconde o container de questões
    questoesContainer.style.display = "none";

    // Evento de clique no botão "Gerar Atividade"
    gerarAtividadeBtn.addEventListener("click", function () {
        console.log("Botão 'Gerar atividade' clicado.");

        var quantidade = quantidadeInput.value.trim();

        // Validação do campo "Quantidade de questões"
        if (!quantidade || isNaN(quantidade) || quantidade <= 0 || quantidade > 50) {
            alert("Por favor, insira um número válido de questões (1 a 50).");
            return;
        }

        // Oculta a mensagem inicial
        if (whiteSpace) {
            whiteSpace.style.display = "none";
        }

        // Faz a requisição para buscar as questões
        var params = new URLSearchParams(new FormData(document.querySelector("#filtro-questoes-form")));
        // Faz a requisição para buscar as questões
fetch(`/aluno/praticar/api/questoes?${params.toString()}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("Dados recebidos da API:", data);
        questoesContainer.innerHTML = "";
        questoesContainer.style.display = "block"; // Mostra a área de questões

        // Verifica se há questões retornadas
        if (!data.questoes || data.questoes.length === 0) {
            console.warn("Nenhuma questão encontrada.");
            questoesContainer.innerHTML = "<p>Nenhuma questão encontrada.</p>";
            return;
        }

        // Renderizar questões
        data.questoes.forEach((questao, index) => {
            var questaoElement = document.createElement("div");
            questaoElement.classList.add("questao-item");

            // Resolução com botão de visibilidade
            var resolucaoHTML = `
                <div class="resolucao">
                    <h3 style="display: flex; justify-content: space-between; align-items: center;">
                        Resolução:
                        <button class="toggle-visibility" data-target="resolucao-section-${index}">
                            <img src="{% static 'assets/eye-off.svg' %}" alt="Olho fechado" class="eye-off">
                            <img src="{% static 'assets/eye-show.svg' %}" alt="Olho aberto" class="eye-show" style="display: none;">
                        </button>
                    </h3>
                    <div id="resolucao-section-${index}" class="resolucao-content hidden" style="display: none;">
                        <div>
                            ${questao.resolucao || "Nenhuma resolução disponível."}
                        </div>
                    </div>
                </div>`;

            // Conteúdo da questão
            questaoElement.innerHTML = `
                <h3>Questão ${index + 1}</h3>
                <p>${questao.descricao}</p>
                <ul>
                    ${questao.alternativas.map(alt => `
                        <li>
                            <input type="radio" id="alt-${alt.id}" name="alternativa-${questao.id}" value="${alt.id}">
                            <label for="alt-${alt.id}">${alt.descricao}</label>
                        </li>`).join("")}
                </ul>
                ${resolucaoHTML}`;

            questoesContainer.appendChild(questaoElement);
        });

        // Adiciona botão "Finalizar atividade"
        var finalizarAtividadeBtn = document.createElement("button");
        finalizarAtividadeBtn.id = "finalizar-atividade";
        finalizarAtividadeBtn.className = "btn-confirm-sim";
        finalizarAtividadeBtn.style.fontWeight = "500";
        finalizarAtividadeBtn.style.marginTop = "10px";
        finalizarAtividadeBtn.textContent = "Finalizar atividade";
        questoesContainer.appendChild(finalizarAtividadeBtn);

        // Ativar os botões de visibilidade
        ativarBotoesVisibilidade();

        // Renderiza o LaTeX com MathJax
        if (window.MathJax && window.MathJax.typeset) {
            window.MathJax.typeset();
        }
    })
    .catch(error => console.error("Erro ao buscar questões:", error));


    // Função para verificar se o formulário está válido
    function verificarFormulario() {
        var quantidadeValida = quantidadeInput.value >= 1 && quantidadeInput.value <= 50;
        newGerarAtividadeBtn.disabled = !quantidadeValida;
    }

    // Adiciona eventos de input no campo de quantidade
    quantidadeInput.addEventListener("input", verificarFormulario);

    // Inicializa o estado do botão
    verificarFormulario();
    });
});
</script>
